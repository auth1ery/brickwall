<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>verifying... — brickwall</title>
<link rel="stylesheet" href="/css/shared.css">
<style>
body{min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.bg-lines{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 40px,rgba(255,255,255,.018) 40px,rgba(255,255,255,.018) 41px),repeating-linear-gradient(90deg,transparent,transparent 40px,rgba(255,255,255,.012) 40px,rgba(255,255,255,.012) 41px);pointer-events:none}
.glow{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:600px;height:600px;background:radial-gradient(circle,rgba(217,95,43,.05) 0%,transparent 70%);pointer-events:none}

.box{
  width:100%;max-width:340px;padding:0 20px;text-align:center;
  animation:fadeIn .4s ease both;
}
.logo{
  font-family:var(--display);font-size:15px;font-weight:800;letter-spacing:-.3px;
  color:var(--muted);margin-bottom:40px;display:block;
}
.logo span{color:var(--accent)}

.status-ring{
  width:72px;height:72px;border-radius:50%;border:2px solid var(--border2);
  display:flex;align-items:center;justify-content:center;margin:0 auto 24px;
  position:relative;transition:border-color .3s;
}
.status-ring.checking{border-color:var(--accent);animation:pulse-ring 1.2s ease-in-out infinite}
.status-ring.pass{border-color:var(--green)}
.status-ring.fail{border-color:var(--red)}
@keyframes pulse-ring{0%,100%{box-shadow:0 0 0 0 rgba(217,95,43,.3)}50%{box-shadow:0 0 0 8px rgba(217,95,43,0)}}

.status-inner{width:36px;height:36px;border-radius:50%;border:2px solid var(--border2);border-top-color:var(--accent);animation:spin .7s linear infinite;transition:all .3s}
.status-ring.pass .status-inner{animation:none;border-color:var(--green);background:rgba(74,158,107,.12)}
.status-ring.fail .status-inner{animation:none;border-color:var(--red);background:rgba(196,74,58,.12)}
.pass-check,.fail-x{display:none;position:absolute;font-size:18px}
.status-ring.pass .pass-check{display:block;color:var(--green)}
.status-ring.fail .fail-x{display:block;color:var(--red)}
.status-ring.pass .status-inner,.status-ring.fail .status-inner{opacity:0}

.headline{font-family:var(--display);font-size:18px;font-weight:700;margin-bottom:8px;letter-spacing:-.3px}
.subline{color:var(--muted);font-size:12px;line-height:1.7;max-width:260px;margin:0 auto}

.progress-bar{
  margin-top:28px;height:2px;background:var(--border);border-radius:1px;overflow:hidden;
}
.progress-fill{height:100%;background:var(--accent);width:0%;transition:width .3s ease;border-radius:1px}

.steps-log{
  margin-top:24px;text-align:left;background:var(--surface);border:1px solid var(--border);
  border-radius:4px;padding:12px 14px;font-size:10px;font-family:var(--mono);
  color:var(--muted);max-height:100px;overflow:hidden;
}
.log-line{opacity:.5;transition:opacity .3s;margin-bottom:2px}
.log-line.done{opacity:1;color:var(--text2)}
.log-line.active{opacity:1;color:var(--accent2);animation:blink 1s ease-in-out infinite}
.log-line::before{content:'> '}

.error-box{
  margin-top:20px;background:rgba(196,74,58,.08);border:1px solid rgba(196,74,58,.2);
  border-radius:4px;padding:12px;font-size:11px;color:var(--red);display:none;line-height:1.6;
}
.retry-btn{margin-top:16px;display:none}

.blocked-box{
  margin-top:20px;background:rgba(196,74,58,.06);border:1px solid rgba(196,74,58,.15);
  border-radius:4px;padding:16px;font-size:11px;color:var(--text2);display:none;line-height:1.7;
  text-align:left;
}
.blocked-box strong{color:var(--red);font-family:var(--display)}

.noscript-msg{color:var(--red);font-size:12px;margin-top:16px}

.brickwall-badge{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 12px;border-radius:20px;
  background:var(--surface);border:1px solid var(--border);
  font-size:10px;color:var(--muted);font-family:var(--mono);
  text-decoration:none;transition:border-color .2s,color .2s;
  white-space:nowrap;
}
.brickwall-badge:hover{border-color:var(--accent);color:var(--text2)}
.brickwall-badge span{color:var(--accent);font-weight:700}
</style>
</head>
<body>

<div class="noise"></div>
<div class="bg-lines"></div>
<div class="glow" id="glowEl"></div>


<input id="bw-hp" type="text" name="website" value="" autocomplete="off"
  tabindex="-1" aria-hidden="true"
  style="opacity:0;position:fixed;top:-200vh;left:-200vw;pointer-events:none;width:1px;height:1px">

<noscript>
<div class="box">
  <a class="logo" href="/">brick<span>wall</span></a>
  <p class="noscript-msg">javascript is required to complete verification. please enable it and reload.</p>
</div>
</noscript>

<div class="box" id="mainBox">
  <a class="logo" href="/" id="logoEl">brick<span>wall</span></a>

  <div class="status-ring checking" id="statusRing">
    <div class="status-inner"></div>
    <span class="pass-check">✓</span>
    <span class="fail-x">✕</span>
  </div>

  <div class="headline" id="headline">verifying your browser</div>
  <p class="subline" id="subline">this only takes a moment. you won't see this again for a while.</p>

  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

  <div class="steps-log" id="stepsLog">
    <div class="log-line active" id="step1">checking environment</div>
    <div class="log-line" id="step2">running proof-of-work</div>
    <div class="log-line" id="step3">verifying result</div>
    <div class="log-line" id="step4">issuing token</div>
  </div>

  <div class="error-box" id="errorBox"></div>
  <button class="btn btn-ghost retry-btn" id="retryBtn" onclick="location.reload()">try again</button>

  <div class="blocked-box" id="blockedBox">
    <strong>access denied</strong><br>
    your connection has been blocked by this site's protection settings. this may be because you're using a vpn, tor, or a known datacenter ip range. if you think this is a mistake, contact the site owner.
  </div>
</div>

<a class="brickwall-badge" id="bwBadge" href="https://brickwall.onrender.com" target="_blank" rel="noopener">
  protected by brick<span>wall</span>
</a>

<script>
const params = new URLSearchParams(location.search)
const siteKey = params.get('k')
const returnUrl = params.get('r') || '/'

function setProgress(p) { document.getElementById('progressFill').style.width = p + '%' }
function setStep(i, state) {
  const el = document.getElementById('step' + i)
  if (!el) return
  el.classList.remove('active','done')
  if (state) el.classList.add(state)
}
function setStatus(state) {
  const ring = document.getElementById('statusRing')
  ring.className = 'status-ring ' + state
}

function applyChallengeUi(ui) {
  if (!ui || typeof ui !== 'object') return
  const root = document.documentElement
  const colorMap = { bg:'--bg', accent:'--accent', text:'--text', text2:'--text2', surface:'--surface', muted:'--muted', border:'--border', border2:'--border2' }
  if (ui.colors && typeof ui.colors === 'object') {
    Object.entries(colorMap).forEach(([k, cssVar]) => { if (ui.colors[k]) root.style.setProperty(cssVar, ui.colors[k]) })
    if (ui.colors.accent) {
      const hex = ui.colors.accent
      const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16)
      document.getElementById('glowEl').style.background = `radial-gradient(circle,rgba(${r},${g},${b},.06) 0%,transparent 70%)`
    }
  }
  if (ui.css) { const s = document.createElement('style'); s.id='bw-custom-css'; s.textContent=ui.css; document.head.appendChild(s) }
  if (ui.logoText) document.getElementById('logoEl').textContent = ui.logoText
  if (ui.headline) document.getElementById('headline').textContent = ui.headline
  if (ui.subline) document.getElementById('subline').textContent = ui.subline
  if (ui.hideBadge) document.getElementById('bwBadge').style.display = 'none'
  if (ui.hideStepsLog) document.getElementById('stepsLog').style.display = 'none'
}

function showError(msg) {
  setStatus('fail')
  document.getElementById('headline').textContent = 'verification failed'
  document.getElementById('subline').textContent = 'something went wrong.'
  const eb = document.getElementById('errorBox')
  eb.textContent = msg; eb.style.display = 'block'
  document.getElementById('retryBtn').style.display = 'inline-flex'
}

function showBlocked() {
  setStatus('fail')
  document.getElementById('headline').textContent = 'access denied'
  document.getElementById('subline').textContent = ''
  document.getElementById('stepsLog').style.display = 'none'
  document.getElementById('blockedBox').style.display = 'block'
}

const SIG_WEBDRIVER_PROP   = 1    
const SIG_NO_PLUGINS       = 2    
const SIG_NO_LANGUAGES     = 4    
const SIG_LOW_CONCURRENCY  = 8    
const SIG_MISSING_CHROME   = 16   
const SIG_WEBDRIVER_ATTR   = 32   
const SIG_BOT_GLOBALS      = 64   
const SIG_PERM_DENIED      = 128  
const SIG_SOFTWARE_GL      = 256  

async function collectSignals() {
  let signals = 0

  try {

    if ('webdriver' in navigator) signals |= SIG_WEBDRIVER_PROP
    if (navigator.plugins && navigator.plugins.length === 0) signals |= SIG_NO_PLUGINS
    if (!navigator.languages || navigator.languages.length === 0) signals |= SIG_NO_LANGUAGES
    if (typeof navigator.hardwareConcurrency !== 'undefined' && navigator.hardwareConcurrency <= 1) signals |= SIG_LOW_CONCURRENCY
  } catch {}

  try {
    const ua = navigator.userAgent || ''
    const isChromeLike = /Chrome\/\d/.test(ua)
    if (isChromeLike) {
      
      if (!window.chrome) {
        signals |= SIG_MISSING_CHROME
      } else if (!window.chrome.runtime || typeof window.chrome.runtime.sendMessage !== 'function') {
        signals |= SIG_MISSING_CHROME
      }
    }
    
    if (document.documentElement.hasAttribute('webdriver')) signals |= SIG_WEBDRIVER_ATTR
    
    if (Object.getOwnPropertyNames(document).some(k => k.startsWith('$cdc_'))) signals |= SIG_WEBDRIVER_ATTR
    if (Object.getOwnPropertyNames(window).some(k => k.startsWith('$cdc_'))) signals |= SIG_WEBDRIVER_ATTR
  } catch {}

  try {
    const botGlobals = [
      'callPhantom','_phantom','__nightmare','__selenium_unwrapped',
      '__webdriver_evaluate','domAutomation','domAutomationController',
      '__webdriver_script_function','_Selenium_IDE_Recorder','__lastWatirAlert',
      'awesomium'
    ]
    if (botGlobals.some(k => k in window && window[k] !== undefined)) signals |= SIG_BOT_GLOBALS
  } catch {}

  try {
    if (navigator.permissions) {
      const r = await navigator.permissions.query({ name: 'notifications' })
      if (r.state === 'denied') signals |= SIG_PERM_DENIED
    }
  } catch {}

  try {
    const c = document.createElement('canvas')
    const gl = c.getContext('webgl') || c.getContext('experimental-webgl')
    if (gl) {
      const ext = gl.getExtension('WEBGL_debug_renderer_info')
      if (ext) {
        const renderer = (gl.getParameter(ext.UNMASKED_RENDERER_WEBGL) || '').toLowerCase()
        if (renderer.includes('swiftshader') || renderer.includes('llvmpipe') ||
            renderer.includes('softpipe') || renderer.includes('software rasterizer')) {
          signals |= SIG_SOFTWARE_GL
        }
      }
    }
  } catch {}

  return signals
}

function countBits(n) { let c=0; while(n){c+=n&1;n>>>=1} return c }

async function getCanvasFingerprint(seed) {
  try {
    const c = document.createElement('canvas')
    c.width = 240; c.height = 60
    const ctx = c.getContext('2d')
    if (!ctx) return 'nocanvas'

    ctx.textBaseline = 'top'
    ctx.font = '13px monospace'
    ctx.fillStyle = 'rgba(217,95,43,0.9)'
    ctx.fillRect(2, 2, 120, 28)
    ctx.fillStyle = '#1a1a1a'
    ctx.fillText('bw:' + seed.slice(0, 12), 6, 8)
    ctx.fillStyle = 'rgba(74,158,107,0.6)'
    ctx.fillText('bw:' + seed.slice(12, 24), 8, 24)
    ctx.strokeStyle = 'rgba(255,255,255,0.15)'
    ctx.lineWidth = 1.5
    ctx.beginPath()
    ctx.arc(180, 30, 22, 0, Math.PI * 2)
    ctx.stroke()

    ctx.fillStyle = 'rgba(102,153,204,0.4)'
    ctx.fillText(seed.slice(0, 8), 120, 40)

    const dataUrl = c.toDataURL('image/png')
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(dataUrl))
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('')
  } catch {
    return 'canvaserr'
  }
}

async function hashCheck(id, fp, nonce) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(id + ':' + fp + ':' + nonce))
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('')
}

async function solvePoW(challengeId, difficulty, canvasFingerprint) {
  const prefix = '0'.repeat(difficulty)
  let nonce = 0
  const start = Date.now()
  while (true) {
    const h = await hashCheck(challengeId, canvasFingerprint, String(nonce))
    if (h.startsWith(prefix)) return { nonce: String(nonce), elapsed: Date.now() - start }
    nonce++
    if (nonce % 500 === 0) await new Promise(r => setTimeout(r, 0))
  }
}

function measureLayout(renderSeed) {
  try {
    const el = document.createElement('div')
    el.style.cssText = [
      'position:fixed', 'left:-9999px', 'top:-9999px',
      'width:' + renderSeed + 'px', 'height:1px',
      'visibility:hidden', 'pointer-events:none'
    ].join(';')
    document.body.appendChild(el)
    const w = el.offsetWidth
    document.body.removeChild(el)
    return w
  } catch { return -1 }
}

let _mouseEvents = []
let _mouseHandler = null

function startMouseCollection() {
  _mouseHandler = function(e) {
    if (_mouseEvents.length < 60) _mouseEvents.push({ x: e.clientX, y: e.clientY, t: Date.now() })
  }
  document.addEventListener('mousemove', _mouseHandler, { passive: true })
}

function stopMouseCollection() {
  if (_mouseHandler) document.removeEventListener('mousemove', _mouseHandler)
}

function scoreMouseEntropy() {
  const ev = _mouseEvents

  if (ev.length < 3) return 0

  const angles = []
  for (let i = 1; i < ev.length - 1; i++) {
    const dx1 = ev[i].x - ev[i-1].x, dy1 = ev[i].y - ev[i-1].y
    const dx2 = ev[i+1].x - ev[i].x, dy2 = ev[i+1].y - ev[i].y
    const a1 = Math.atan2(dy1, dx1), a2 = Math.atan2(dy2, dx2)
    let diff = Math.abs(a2 - a1)
    if (diff > Math.PI) diff = 2 * Math.PI - diff
    angles.push(diff)
  }
  if (!angles.length) return 0
  const mean = angles.reduce((s, v) => s + v, 0) / angles.length
  const variance = angles.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / angles.length
  return Math.min(1, variance * 4) 
}

async function run() {
  if (!siteKey) { showError('missing site key. this page should not be accessed directly.'); return }

  startMouseCollection()

  const signals = await collectSignals()

  const hardBotSignals = SIG_WEBDRIVER_PROP | SIG_BOT_GLOBALS | SIG_WEBDRIVER_ATTR
  if ((signals & hardBotSignals) !== 0) {
    showError('automated browser detected.')
    return
  }

  setProgress(10)
  setStep(1, 'active')

  let initData
  try {
    const r = await fetch('/api/challenge/init', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ siteKey, returnUrl })
    })
    const d = await r.json()
    if (r.status === 403 && d.reason === 'tor') { showBlocked(); return }
    if (r.status === 429) { showError('too many attempts! try again in ' + (d.retryAfter || 60) + ' seconds.'); return }
    if (!r.ok) { showError((d.error || 'failed to initialize challenge.') + (d.error === 'unknown site key' ? ' — make sure your site key is correct and the site exists in your dashboard.' : '')); return }
    applyChallengeUi(d.challengeUi)
    if (d.skip && d.token) {
      setStatus('pass')
      document.getElementById('headline').textContent = 'verified'
      document.getElementById('subline').textContent = 'redirecting...'
      setProgress(100)
      setTimeout(() => { window.location.href = appendToken(returnUrl, d.token) }, 600)
      return
    }
    initData = d
  } catch { showError('network error. check your connection.'); return }

  setStep(1, 'done')
  setStep(2, 'active')
  setProgress(25)

  const renderSeed = initData.renderSeed || 150
  const renderWidth = measureLayout(renderSeed)

  const canvasFingerprint = await getCanvasFingerprint(initData.challengeId)

  setProgress(35)

  let powResult
  try {
    powResult = await solvePoW(initData.challengeId, initData.difficulty, canvasFingerprint)
  } catch { showError('challenge failed. try again next time?'); return }

  setStep(2, 'done')
  setStep(3, 'active')
  setProgress(70)

  stopMouseCollection()
  const mouseScore = scoreMouseEntropy()

  const honeypotVal = (document.getElementById('bw-hp') || {}).value || ''

  let token
  try {
    const r = await fetch('/api/challenge/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        challengeId: initData.challengeId,
        nonce: powResult.nonce,
        elapsed: powResult.elapsed,
        canvasFingerprint,    
        signals,              
        mouseScore,           
        renderWidth,          
        honeypot: honeypotVal 
      })
    })
    const d = await r.json()
    if (!r.ok) { showError('challenge verification failed. you may be a bot?'); return }
    token = d.token
  } catch { showError('network error during verification. try again...'); return }

  setStep(3, 'done')
  setStep(4, 'active')
  setProgress(90)

  await new Promise(r => setTimeout(r, 300))
  setStep(4, 'done')
  setProgress(100)
  setStatus('pass')
  document.getElementById('headline').textContent = 'verified'
  document.getElementById('subline').textContent = 'redirecting you now...'
  await new Promise(r => setTimeout(r, 500))
  window.location.href = appendToken(returnUrl, token)
}

function appendToken(url, token) {
  try {
    var u = new URL(url)
    u.searchParams.set('bw_token', token)
    return u.toString()
  } catch {
    var sep = url.includes('?') ? '&' : '?'
    return url + sep + 'bw_token=' + encodeURIComponent(token)
  }
}

run()
</script>
</body>
</html>
