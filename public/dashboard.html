<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dashboard — brickwall</title>
<link rel="stylesheet" href="/css/shared.css">
<style>
body{display:flex;flex-direction:column;height:100vh;overflow:hidden}
#appShell{display:flex;flex:1;min-height:0;overflow:hidden}

#authWall{
  position:fixed;inset:0;background:var(--bg);z-index:9000;
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;
}
#authWall .logo{font-family:var(--display);font-size:20px;font-weight:800;letter-spacing:-.4px}
#authWall .logo span{color:var(--accent)}
#authWall p{color:var(--muted);font-size:12px}
#authWall.hidden{display:none}

.sidebar{
  width:220px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;
}
.sidebar-logo{
  padding:18px 16px 14px;border-bottom:1px solid var(--border);
  font-family:var(--display);font-size:16px;font-weight:800;letter-spacing:-.4px;
  display:flex;align-items:center;justify-content:space-between;
}
.sidebar-logo span{color:var(--accent)}
.sidebar-close{display:none;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1;padding:2px 4px}
.sidebar-section{padding:10px 10px 4px;font-size:9px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
.nav-item{
  display:flex;align-items:center;gap:9px;padding:9px 12px;margin:1px 6px;
  border-radius:3px;cursor:pointer;font-size:12px;color:var(--text2);
  transition:all .15s;border:1px solid transparent;
}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:var(--bg);border-color:var(--border);color:var(--text)}
.nav-item .icon{font-size:13px;width:16px;text-align:center;flex-shrink:0}

.site-picker{padding:10px 8px;border-bottom:1px solid var(--border)}
.site-select-wrap{position:relative}
.site-select-wrap select{
  padding-right:28px;cursor:pointer;appearance:none;
  font-size:11px;border-color:var(--border);color:var(--text);background:var(--bg);
}
.site-select-wrap::after{
  content:'▾';position:absolute;right:10px;top:50%;transform:translateY(-50%);
  color:var(--muted);pointer-events:none;font-size:10px;
}

.sidebar-bottom{margin-top:auto;border-top:1px solid var(--border);padding:10px 8px}
.user-chip{display:flex;align-items:center;gap:8px;padding:8px;border-radius:3px}
.user-avatar{
  width:28px;height:28px;border-radius:3px;background:var(--accent);
  display:flex;align-items:center;justify-content:center;font-size:11px;
  font-family:var(--display);font-weight:700;color:#fff;flex-shrink:0;
}
.user-info{min-width:0;flex:1}
.user-name{font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.user-email{font-size:10px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.logout-btn{
  background:none;border:none;color:var(--muted);font-size:10px;cursor:pointer;
  padding:4px 8px;font-family:var(--mono);transition:color .2s;display:block;width:100%;text-align:left;
}
.logout-btn:hover{color:var(--red)}

.main{flex:1;display:flex;flex-direction:column;min-width:0;min-height:0;overflow:hidden}
.topbar{
  padding:12px 20px;border-bottom:1px solid var(--border);display:flex;
  align-items:center;justify-content:space-between;flex-shrink:0;
  background:var(--bg);z-index:10;gap:10px;
}
.topbar-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
.menu-btn{
  display:none;background:none;border:1px solid var(--border);color:var(--text2);
  width:32px;height:32px;border-radius:3px;cursor:pointer;font-size:14px;
  align-items:center;justify-content:center;flex-shrink:0;
}
.page-title{font-family:var(--display);font-size:15px;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
.page-sub{color:var(--muted);font-size:11px;margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.content{padding:20px;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}

.panel{display:none}
.panel.active{display:block;animation:fadeIn .2s ease both}

.stat-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:14px 16px}
.sc-label{font-size:10px;color:var(--muted);letter-spacing:.04em;margin-bottom:6px}
.sc-value{font-family:var(--display);font-size:26px;font-weight:700;letter-spacing:-1px;line-height:1}
.sc-sub{font-size:10px;color:var(--muted);margin-top:4px}

.req-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:4px;overflow:hidden}
.req-table-head{
  padding:10px 14px;border-bottom:1px solid var(--border);display:flex;
  align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.req-table-head-title{font-family:var(--display);font-size:13px;font-weight:600}
.req-table-head-actions{display:flex;gap:8px;align-items:center}
.filter-input{width:160px;font-size:11px}
table{width:100%;border-collapse:collapse}
th{padding:8px 12px;text-align:left;font-size:9px;letter-spacing:.08em;color:var(--muted);font-weight:500;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap}
td{padding:9px 12px;font-size:11px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.02)}
.req-country{font-size:12px;font-weight:500}
.req-detected{font-size:10px;color:var(--muted)}
.req-ts{color:var(--muted);font-size:10px;white-space:nowrap}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted);font-size:12px;line-height:1.8}

.req-cards{display:none;flex-direction:column}
.req-card{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
.req-card:last-child{border-bottom:none}
.req-card-country{font-size:12px;font-weight:500;margin-bottom:3px}
.req-card-meta{font-size:10px;color:var(--muted)}
.req-card-right{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0}
.req-card-ts{font-size:10px;color:var(--muted)}

.install-wrap{max-width:660px}
.install-steps{display:flex;flex-direction:column;gap:0;margin-bottom:18px;background:var(--surface);border:1px solid var(--border);border-radius:4px;overflow:hidden}
.install-step{display:flex;gap:14px;padding:18px 16px;border-bottom:1px solid var(--border)}
.install-step:last-child{border-bottom:none}
.install-step-num{width:22px;height:22px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--muted);flex-shrink:0;font-family:var(--display);font-weight:700;margin-top:2px}
.install-step-title{font-family:var(--display);font-size:13px;font-weight:600;margin-bottom:7px}
.install-step-desc{color:var(--muted);font-size:11px;line-height:1.75;margin-bottom:10px}
.install-step-desc:last-child{margin-bottom:0}

.install-block{background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;overflow:hidden}
.install-block-head{padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--display);font-size:13px;font-weight:600}
.install-block-body{padding:14px}
.install-note{color:var(--muted);font-size:11px;line-height:1.75;margin-top:10px}

.code-block{
  background:var(--bg);border:1px solid var(--border2);border-radius:3px;
  padding:10px 12px;padding-top:32px;font-size:11px;color:var(--accent2);
  font-family:var(--mono);overflow-x:auto;white-space:pre;line-height:1.7;position:relative;
}
.code-copy{
  position:absolute;top:8px;right:8px;background:var(--surface);border:1px solid var(--border);
  color:var(--muted);padding:3px 10px;border-radius:2px;font-size:10px;cursor:pointer;
  font-family:var(--mono);transition:all .2s;
}
.code-copy:hover{border-color:var(--accent);color:var(--accent)}

.key-row{display:flex;align-items:center;gap:8px;background:var(--bg);border:1px solid var(--border2);border-radius:3px;padding:10px 12px;font-size:11px;font-family:var(--mono);color:var(--accent2);flex-wrap:wrap}
.key-val{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:120px}
.key-actions{display:flex;gap:6px;flex-shrink:0}

.settings-form{max-width:500px}
.settings-group{background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;overflow:hidden}
.settings-group-head{padding:11px 16px;border-bottom:1px solid var(--border);font-family:var(--display);font-size:13px;font-weight:600}
.settings-group-body{padding:14px 16px}
.settings-row{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding:10px 0;border-bottom:1px solid var(--border)}
.settings-row:last-child{border-bottom:none;padding-bottom:0}
.settings-row:first-child{padding-top:0}
.settings-label{font-size:12px;color:var(--text2)}
.settings-desc{font-size:10px;color:var(--muted);margin-top:3px;line-height:1.5;max-width:300px}
.toggle{position:relative;width:34px;height:19px;flex-shrink:0;margin-top:2px}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--border2);border-radius:10px;cursor:pointer;transition:.2s}
.toggle-slider::before{content:'';position:absolute;width:13px;height:13px;background:#fff;border-radius:50%;bottom:3px;left:3px;transition:.2s}
.toggle input:checked + .toggle-slider{background:var(--accent)}
.toggle input:checked + .toggle-slider::before{transform:translateX(15px)}
.settings-ttl{display:flex;align-items:center;gap:8px;margin-top:2px;flex-wrap:wrap}
.ttl-input{width:70px}

.sites-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.site-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px;cursor:pointer;transition:border-color .15s}
.site-card:hover{border-color:var(--border2)}
.site-card.selected{border-color:var(--accent)}
.site-card-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;gap:8px}
.site-card-name{font-family:var(--display);font-size:14px;font-weight:600;letter-spacing:-.3px}
.site-card-domain{color:var(--muted);font-size:11px;margin-top:2px}
.site-card-key{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.add-site-btn{background:var(--surface);border:1px dashed var(--border2);border-radius:4px;padding:16px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted);font-size:12px;min-height:100px}
.add-site-btn:hover{border-color:var(--accent);color:var(--accent)}

.empty-first{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:36px 24px;text-align:center;max-width:400px}
.empty-first h3{font-family:var(--display);font-size:17px;font-weight:700;margin-bottom:10px;letter-spacing:-.3px}
.empty-first p{color:var(--muted);font-size:12px;line-height:1.8;margin-bottom:20px}

.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);
  z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;
  opacity:0;pointer-events:none;transition:opacity .2s;
}
.modal-bg.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:5px;padding:24px;width:100%;max-width:360px;position:relative;transform:translateY(8px);transition:transform .2s}
.modal-bg.open .modal{transform:translateY(0)}
.modal h3{font-family:var(--display);font-size:17px;font-weight:700;margin-bottom:18px;letter-spacing:-.3px}
.modal .field{margin-bottom:14px}
.modal-close{position:absolute;top:10px;right:14px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1}
.modal-error{color:var(--red);font-size:11px;margin-top:8px;display:none}

.danger-zone{margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.danger-zone h4{font-family:var(--display);font-size:11px;font-weight:600;color:var(--red);margin-bottom:10px;letter-spacing:.06em;text-transform:uppercase}

.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:199}

.terminal-modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);
  z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;
  opacity:0;pointer-events:none;transition:opacity .15s;
}
.terminal-modal-bg.open{opacity:1;pointer-events:all}
.terminal-modal{
  background:var(--bg);border:1px solid var(--border2);border-radius:5px;
  width:100%;max-width:480px;overflow:hidden;
  transform:translateY(6px);transition:transform .15s;
}
.terminal-modal-bg.open .terminal-modal{transform:translateY(0)}
.terminal-header{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:10px 14px;display:flex;align-items:center;gap:8px;
}
.terminal-dot{width:10px;height:10px;border-radius:50%;background:var(--border2)}
.terminal-dot.red{background:#c44a3a}
.terminal-title{font-size:11px;color:var(--muted);margin-left:4px;font-family:var(--mono)}
.terminal-body{padding:18px}
.terminal-desc{font-size:11px;color:var(--text2);line-height:1.75;margin-bottom:16px}
.terminal-cmd-label{font-size:10px;color:var(--muted);margin-bottom:8px;letter-spacing:.04em}
.terminal-prompt{
  font-family:var(--mono);font-size:11px;color:var(--accent2);
  background:var(--surface);border:1px solid var(--border);border-radius:3px;
  padding:9px 12px;margin-bottom:14px;word-break:break-all;line-height:1.6;
  user-select:all;cursor:text;
}
.terminal-input-label{font-size:10px;color:var(--muted);margin-bottom:6px;letter-spacing:.04em}
.terminal-input-wrap{position:relative;display:flex;align-items:center;gap:0}
.terminal-caret{
  font-family:var(--mono);font-size:12px;color:var(--accent);padding:9px 0 9px 12px;
  background:var(--surface2);border:1px solid var(--border2);border-right:none;border-radius:3px 0 0 3px;
  flex-shrink:0;line-height:1;
}
.terminal-input{
  border-radius:0 3px 3px 0;border-left:none;background:var(--surface2);
  border-color:var(--border2);font-size:11px;color:var(--text);
}
.terminal-input:focus{border-color:var(--accent);outline:none;box-shadow:none}
.terminal-error{color:var(--red);font-size:11px;margin-top:8px;display:none}
.terminal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}

@media(max-width:900px){.stat-cards{grid-template-columns:repeat(2,1fr)}}
@media(max-width:680px){
  .sidebar{position:fixed;left:-240px;top:0;bottom:0;width:240px;z-index:200;transition:left .25s ease}
  .sidebar.open{left:0;box-shadow:4px 0 24px rgba(0,0,0,.5)}
  .sidebar-close{display:block}
  .sidebar-overlay.open{display:block}
  .menu-btn{display:flex}
  .main{min-height:0}
  .content{padding:14px}
  table{display:none}
  .req-cards{display:flex}
  .filter-input{width:120px}
  .install-wrap,.settings-form{max-width:100%}
  .code-block{font-size:10px}
  .sites-grid{grid-template-columns:1fr}
  .key-actions{width:100%}
  .key-actions .btn{flex:1;justify-content:center}
  .settings-ttl{gap:6px}
}
@media(max-width:440px){
  .stat-cards{grid-template-columns:1fr 1fr}
  .sc-value{font-size:22px}
  .topbar{padding:10px 14px}
  .content{padding:12px}
}
</style>
</head>
<body>
<div class="noise"></div>

<div id="authWall">
  <div class="logo">brick<span>wall</span></div>
  <div class="spinner"></div>
  <p>loading...</p>
</div>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div id="appShell" style="display:none">
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    brick<span>wall</span>
    <button class="sidebar-close" onclick="closeSidebar()">×</button>
  </div>
  <div class="site-picker">
    <label>active site</label>
    <div class="site-select-wrap">
      <select id="siteSelect" onchange="onSiteChange()"><option value="">no sites yet</option></select>
    </div>
  </div>
  <div class="sidebar-section">overview</div>
  <div class="nav-item active" onclick="nav('overview')" id="nav-overview"><span class="icon">▦</span> overview</div>
  <div class="nav-item" onclick="nav('requests')" id="nav-requests"><span class="icon">◈</span> all requests</div>
  <div class="sidebar-section">setup</div>
  <div class="nav-item" onclick="nav('install')" id="nav-install"><span class="icon">⌥</span> installation</div>
  <div class="nav-item" onclick="nav('settings')" id="nav-settings"><span class="icon">⚙</span> site settings</div>
  <div class="sidebar-section">account</div>
  <div class="nav-item" onclick="nav('sites')" id="nav-sites"><span class="icon">◫</span> manage sites</div>
  <div class="nav-item" onclick="nav('account')" id="nav-account"><span class="icon">⊘</span> account</div>
  <div class="sidebar-bottom">
    <div class="user-chip">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-info">
        <div class="user-name" id="userName">loading...</div>
        <div class="user-email" id="userEmail"></div>
      </div>
    </div>
    <button class="logout-btn" onclick="doLogout()">→ log out</button>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div class="topbar-left">
      <button class="menu-btn" onclick="openSidebar()">☰</button>
      <div>
        <div class="page-title" id="pageTitle">overview</div>
        <div class="page-sub" id="pageSub">loading...</div>
      </div>
    </div>
    <div id="topbarActions"></div>
  </div>
  <div class="content">

    <div class="panel active" id="panel-overview">
      <div class="stat-cards" id="statCards">
        <div class="stat-card"><div class="sc-label">total requests</div><div class="sc-value">—</div></div>
        <div class="stat-card"><div class="sc-label">passed</div><div class="sc-value">—</div></div>
        <div class="stat-card"><div class="sc-label">blocked</div><div class="sc-value">—</div></div>
        <div class="stat-card"><div class="sc-label">flagged</div><div class="sc-value">—</div></div>
      </div>
      <div class="req-table-wrap" id="overviewTableWrap">
        <div class="req-table-head">
          <div class="req-table-head-title">recent requests</div>
          <button class="btn btn-ghost btn-sm" onclick="nav('requests')">view all →</button>
        </div>
        <div id="recentReqsTable"></div>
        <div class="req-cards" id="recentReqCards"></div>
      </div>
    </div>

    <div class="panel" id="panel-requests">
      <div class="req-table-wrap">
        <div class="req-table-head">
          <div class="req-table-head-title">all requests</div>
          <div class="req-table-head-actions">
            <input class="filter-input" type="text" placeholder="filter..." oninput="filterReqs(this.value)" id="reqFilter">
            <button class="btn btn-ghost btn-sm" onclick="loadRequests()">↻</button>
          </div>
        </div>
        <div id="allReqsTable"></div>
        <div class="req-cards" id="allReqCards"></div>
      </div>
    </div>

    <div class="panel" id="panel-install">
      <div class="install-wrap" id="installWrap">
        <div class="empty-state">select or add a site to see installation instructions.</div>
      </div>
    </div>

    <div class="panel" id="panel-settings">
      <div class="settings-form" id="settingsWrap">
        <div class="empty-state">select a site to configure its settings.</div>
      </div>
    </div>

    <div class="panel" id="panel-sites">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-family:var(--display);font-size:15px;font-weight:700">all sites</div>
          <div style="color:var(--muted);font-size:11px;margin-top:2px">manage all your protected sites</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openAddSite()">+ add site</button>
      </div>
      <div class="sites-grid" id="sitesGrid"></div>
    </div>

    <div class="panel" id="panel-account">
      <div class="settings-form">
        <div class="settings-group">
          <div class="settings-group-head">account info</div>
          <div class="settings-group-body">
            <div class="settings-row">
              <div><div class="settings-label">name</div></div>
              <div style="font-size:12px;color:var(--text2)" id="acctName">—</div>
            </div>
            <div class="settings-row" style="border-bottom:none;padding-bottom:0">
              <div><div class="settings-label">email</div></div>
              <div style="font-size:12px;color:var(--text2)" id="acctEmail">—</div>
            </div>
          </div>
        </div>
        <div class="danger-zone">
          <h4>danger zone</h4>
          <div>
            <div class="settings-label" style="margin-bottom:4px">delete your account</div>
            <div class="settings-desc" style="margin-bottom:10px">permanently deletes your account, all sites, all api keys, and all request history. there is no going back.</div>
            <button class="btn btn-danger btn-sm" onclick="openDeleteAccount()">delete account</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>
</div>

<div class="modal-bg" id="addSiteModal" onclick="closeAddSiteModal(event)">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('addSiteModal').classList.remove('open')">×</button>
    <h3>add a new site</h3>
    <div class="field"><label>site name</label><input type="text" id="newSiteName" placeholder="my blog" autocomplete="off"></div>
    <div class="field"><label>domain</label><input type="url" id="newSiteDomain" placeholder="https://yoursite.com" autocomplete="off"></div>
    <div class="modal-error" id="addSiteError"></div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px;justify-content:center" onclick="doAddSite()" id="addSiteBtn">add site →</button>
  </div>
</div>

<div class="terminal-modal-bg" id="terminalModal" onclick="if(event.target===this)closeTerminalModal()">
  <div class="terminal-modal">
    <div class="terminal-header">
      <div class="terminal-dot red"></div>
      <div class="terminal-dot"></div>
      <div class="terminal-dot"></div>
      <span class="terminal-title">confirm destructive action</span>
    </div>
    <div class="terminal-body">
      <p class="terminal-desc">this action is <strong style="color:var(--red)">permanent and cannot be undone</strong>. type the command below exactly to confirm.</p>
      <div class="terminal-cmd-label">command to run</div>
      <div class="terminal-prompt" id="terminalPrompt" onclick="navigator.clipboard.writeText(this.textContent.slice(2))">$ ...</div>
      <div class="terminal-input-label">type the command to confirm</div>
      <div class="terminal-input-wrap">
        <span class="terminal-caret">$</span>
        <input class="terminal-input" type="text" id="terminalInput" placeholder="type command here..." autocomplete="off" spellcheck="false" onkeydown="if(event.key==='Enter')confirmTerminalDelete();if(event.key==='Escape')closeTerminalModal()">
      </div>
      <div class="terminal-error" id="terminalError"></div>
      <div class="terminal-actions">
        <button class="btn btn-ghost btn-sm" onclick="closeTerminalModal()">cancel</button>
        <button class="btn btn-danger btn-sm" id="terminalConfirmBtn" onclick="confirmTerminalDelete()">confirm delete</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentUser = null
let sites = []
let currentSiteId = null
let allRequests = []
let filteredRequests = []

async function init() {
  try {
    const r = await fetch('/api/auth/me')
    if (!r.ok) { window.location.href = '/'; return }
    currentUser = await r.json()
    document.getElementById('userName').textContent = currentUser.name
    document.getElementById('userEmail').textContent = currentUser.email
    document.getElementById('userAvatar').textContent = currentUser.name[0].toUpperCase()
    document.getElementById('authWall').classList.add('hidden')
    document.getElementById('appShell').style.display = 'flex'
    await loadSites()
  } catch { window.location.href = '/' }
}

function openSidebar() {
  document.getElementById('sidebar').classList.add('open')
  document.getElementById('sidebarOverlay').classList.add('open')
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open')
  document.getElementById('sidebarOverlay').classList.remove('open')
}

async function loadSites() {
  const r = await fetch('/api/sites')
  if (!r.ok) return
  sites = await r.json()
  const sel = document.getElementById('siteSelect')
  sel.innerHTML = ''
  if (sites.length === 0) {
    sel.innerHTML = '<option value="">no sites yet</option>'
    showNoSites()
    return
  }
  sites.forEach(s => {
    const o = document.createElement('option')
    o.value = s.id
    o.textContent = s.name + ' (' + s.domain + ')'
    sel.appendChild(o)
  })
  if (!currentSiteId || !sites.find(s => s.id === currentSiteId)) currentSiteId = sites[0].id
  sel.value = currentSiteId
  await refreshData()
}

function showNoSites() {
  document.getElementById('pageSub').textContent = 'add your first site to get started'
  document.getElementById('statCards').innerHTML = `
    <div class="stat-card"><div class="sc-label">total requests</div><div class="sc-value" style="color:var(--muted)">0</div></div>
    <div class="stat-card"><div class="sc-label">passed</div><div class="sc-value" style="color:var(--muted)">0</div></div>
    <div class="stat-card"><div class="sc-label">blocked</div><div class="sc-value" style="color:var(--muted)">0</div></div>
    <div class="stat-card"><div class="sc-label">flagged</div><div class="sc-value" style="color:var(--muted)">0</div></div>
  `
  document.getElementById('overviewTableWrap').style.display = 'none'
  const existing = document.getElementById('emptyFirst')
  if (!existing) {
    document.getElementById('panel-overview').insertAdjacentHTML('beforeend', `
      <div class="empty-first" id="emptyFirst">
        <h3>add your first site</h3>
        <p>connect a site to start protecting it. you'll get a unique api key and a one-line script tag to drop into your html.</p>
        <button class="btn btn-primary" style="margin:0 auto" onclick="openAddSite()">+ add site</button>
      </div>
    `)
  }
}

async function onSiteChange() {
  currentSiteId = document.getElementById('siteSelect').value
  allRequests = []
  await refreshData()
}

async function refreshData() {
  if (!currentSiteId) return
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  document.getElementById('pageSub').textContent = site.domain
  const ef = document.getElementById('emptyFirst')
  if (ef) ef.remove()
  document.getElementById('overviewTableWrap').style.display = ''
  await Promise.all([loadStats(), loadRequests(), renderInstall(site), renderSettings(site)])
  renderSitesGrid()
}

async function loadStats() {
  const r = await fetch('/api/sites/' + currentSiteId + '/stats')
  if (!r.ok) return
  const d = await r.json()
  document.getElementById('statCards').innerHTML = `
    <div class="stat-card"><div class="sc-label">total requests</div><div class="sc-value">${d.total}</div><div class="sc-sub">all time</div></div>
    <div class="stat-card"><div class="sc-label">passed</div><div class="sc-value" style="color:var(--green)">${d.passed}</div><div class="sc-sub">${d.total?Math.round(d.passed/d.total*100):0}% rate</div></div>
    <div class="stat-card"><div class="sc-label">blocked</div><div class="sc-value" style="color:var(--red)">${d.blocked}</div><div class="sc-sub">bots stopped</div></div>
    <div class="stat-card"><div class="sc-label">flagged</div><div class="sc-value" style="color:var(--yellow)">${d.flagged}</div><div class="sc-sub">suspicious</div></div>
  `
}

async function loadRequests() {
  const r = await fetch('/api/sites/' + currentSiteId + '/requests')
  if (!r.ok) return
  allRequests = await r.json()
  filteredRequests = [...allRequests]
  renderRecentTable()
  renderAllTable()
}

function renderRecentTable() {
  const recent = allRequests.slice(0, 10)
  document.getElementById('recentReqsTable').innerHTML = buildTable(recent)
  document.getElementById('recentReqCards').innerHTML = buildCards(recent)
}

function renderAllTable() {
  document.getElementById('allReqsTable').innerHTML = buildTable(filteredRequests)
  document.getElementById('allReqCards').innerHTML = buildCards(filteredRequests)
}

function filterReqs(val) {
  const v = val.toLowerCase()
  filteredRequests = allRequests.filter(r =>
    r.country.toLowerCase().includes(v) || r.status.includes(v) || r.detected.includes(v)
  )
  renderAllTable()
}

function buildTable(reqs) {
  if (!reqs.length) return '<div class="empty-state">no requests yet.<br>embed the script on your site and visits will show up here.</div>'
  return `<table><thead><tr><th>location</th><th>detected as</th><th>status</th><th>time</th></tr></thead><tbody>${
    reqs.map(r => `<tr>
      <td><span class="req-country">${esc(r.country)}</span></td>
      <td><span class="req-detected">${r.detected==='N/A'?'—':esc(r.detected)}</span></td>
      <td>${stag(r.status)}</td>
      <td class="req-ts">${fmt(r.ts)}</td>
    </tr>`).join('')
  }</tbody></table>`
}

function buildCards(reqs) {
  if (!reqs.length) return '<div class="empty-state">no requests yet.<br>embed the script on your site and visits will show up here.</div>'
  return reqs.map(r => `<div class="req-card">
    <div>
      <div class="req-card-country">${esc(r.country)}</div>
      <div class="req-card-meta">detected: ${r.detected==='N/A'?'—':esc(r.detected)}</div>
    </div>
    <div class="req-card-right">${stag(r.status)}<div class="req-card-ts">${fmt(r.ts)}</div></div>
  </div>`).join('')
}

function stag(s) {
  const m={passed:'tag-green',blocked:'tag-red',flagged:'tag-yellow'}
  return `<span class="tag ${m[s]||'tag-muted'}">${s}</span>`
}

function fmt(ts) {
  const d=new Date(ts)
  return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes())
}
function p(n){return String(n).padStart(2,'0')}

function renderInstall(site) {
  const key = esc(site.key)
  const ttl = site.settings.challengeTtl || 24
  document.getElementById('installWrap').innerHTML = `
    <div style="margin-bottom:18px">
      <div style="font-family:var(--display);font-size:15px;font-weight:700;margin-bottom:5px">installation</div>
      <p style="color:var(--muted);font-size:12px;line-height:1.75">follow these steps to protect <strong style="color:var(--text2)">${esc(site.domain)}</strong>. no server-side code needed.</p>
    </div>
    <div style="background:rgba(217,95,43,.08);border:1px solid rgba(217,95,43,.25);border-radius:4px;padding:12px 14px;margin-bottom:18px;font-size:11px;line-height:1.75;color:var(--text2)">
      <strong style="color:var(--accent)">⚠ if you're seeing "unknown site key"</strong> — your embed script still has an old key from before the database migration. copy the fresh key below and update the <code style="color:var(--accent2)">data-site</code> attribute in your html.
    </div>
    <div class="install-steps">
      <div class="install-step">
        <div class="install-step-num">1</div>
        <div style="flex:1;min-width:0">
          <div class="install-step-title">copy your site key</div>
          <div class="install-step-desc">this key signs visitor tokens. keep it private — rotating it invalidates all existing tokens immediately.</div>
          <div class="key-row">
            <span class="key-val">${key}</span>
            <div class="key-actions">
              <button class="btn btn-ghost btn-sm" onclick="copyKey()">copy</button>
              <button class="btn btn-ghost btn-sm" onclick="rotateKey()">rotate</button>
            </div>
          </div>
        </div>
      </div>
      <div class="install-step">
        <div class="install-step-num">2</div>
        <div style="flex:1;min-width:0">
          <div class="install-step-title">add the script tag to your site</div>
          <div class="install-step-desc">paste this into the <code style="color:var(--accent2)">&lt;head&gt;</code> of every page you want protected. works on any html — static sites, jamstack, single-page apps.</div>
          <div class="code-block" id="cb-snippet"><button class="code-copy" onclick="cpSnippet(this,'${site.key}')">copy</button>&lt;script src="https://brickwall.onrender.com/js/protect.min.js"
  data-site="${key}"&gt;&lt;/script&gt;</div>
        </div>
      </div>
      <div class="install-step">
        <div class="install-step-num">3</div>
        <div style="flex:1;min-width:0">
          <div class="install-step-title">test it</div>
          <div class="install-step-desc">open your site in a private/incognito window. you should be redirected to the brickwall challenge page, then sent back after passing. the token lasts ${ttl} hour${ttl!==1?'s':''} — configurable in <a href="#" onclick="nav('settings');return false" style="color:var(--accent2)">settings</a>.</div>
          <div class="install-step-desc">once you see requests showing up in the <a href="#" onclick="nav('requests');return false" style="color:var(--accent2)">requests log</a>, you're good.</div>
        </div>
      </div>
    </div>
    <div class="install-block">
      <div class="install-block-head">server-side verification (optional)</div>
      <div class="install-block-body">
        <div class="install-step-desc" style="margin-bottom:10px">if your backend needs to verify tokens independently — e.g. to gate an api route — POST to this endpoint:</div>
        <div class="code-block"><button class="code-copy" onclick="cpRaw(this,\`POST /api/challenge/check\\nContent-Type: application/json\\n\\n{\\n  &quot;token&quot;: &quot;&lt;bw_token&gt;&quot;,\\n  &quot;siteKey&quot;: &quot;${site.key}&quot;\\n}\`)">copy</button>POST /api/challenge/check
Content-Type: application/json

{
  "token": "&lt;bw_token from visitor&gt;",
  "siteKey": "${key}"
}</div>
        <p class="install-note">returns <code style="color:var(--accent2)">{"valid":true}</code> or <code style="color:var(--accent2)">{"valid":false}</code>. the visitor token is stored in their localStorage as <code style="color:var(--accent2)">bw_token_${key}</code>.</p>
      </div>
    </div>
    <div class="install-block">
      <div class="install-block-head">self-hosting the script</div>
      <div class="install-block-body">
        <div class="code-block"><button class="code-copy" onclick="cpRaw(this,'curl -o protect.min.js https://brickwall.onrender.com/js/protect.min.js')">copy</button>curl -o protect.min.js https://brickwall.onrender.com/js/protect.min.js</div>
        <p class="install-note">download and serve from your own cdn if preferred. the <code style="color:var(--accent2)">data-site</code> attribute still needs your key, and <code style="color:var(--accent2)">data-api</code> + <code style="color:var(--accent2)">data-challenge</code> attributes can override the default endpoints.</p>
      </div>
    </div>
  `
}

function cpSnippet(btn, key) {
  navigator.clipboard.writeText(`<script src="https://brickwall.onrender.com/js/protect.min.js" data-site="${key}"><\/script>`)
  btn.textContent='copied!'; setTimeout(()=>btn.textContent='copy',2000)
}

function cpRaw(btn, text) {
  const clean = text.replace(/\\n/g,'\n').replace(/\\"/g,'"').replace(/&quot;/g,'"').replace(/&lt;/g,'<').replace(/&gt;/g,'>')
  navigator.clipboard.writeText(clean)
  btn.textContent='copied!'; setTimeout(()=>btn.textContent='copy',2000)
}

function renderSettings(site) {
  document.getElementById('settingsWrap').innerHTML = `
    <div class="settings-group">
      <div class="settings-group-head">site info</div>
      <div class="settings-group-body">
        <div class="settings-row">
          <div><div class="settings-label">site name</div><div class="settings-desc">display name in your dashboard</div></div>
          <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
            <input type="text" id="settingName" value="${esc(site.name)}" placeholder="my site" style="width:140px;font-size:11px">
            <button class="btn btn-ghost btn-sm" onclick="saveName()">save</button>
          </div>
        </div>
        <div class="settings-row" style="padding-bottom:0;border-bottom:none">
          <div><div class="settings-label">domain</div><div class="settings-desc">${esc(site.domain)}</div></div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head">access control</div>
      <div class="settings-group-body">
        <div class="settings-row">
          <div><div class="settings-label">allow search engine crawlers</div><div class="settings-desc">googlebot, bingbot, etc. auto-bypass and are logged as "crawler"</div></div>
          <label class="toggle"><input type="checkbox" id="setCrawlers" ${site.settings.allowCrawlers?'checked':''} onchange="saveSetting('allowCrawlers',this.checked)"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">block tor exit nodes</div><div class="settings-desc">known tor exit ip ranges are denied before the challenge</div></div>
          <label class="toggle"><input type="checkbox" id="setTor" ${site.settings.blockTor?'checked':''} onchange="saveSetting('blockTor',this.checked)"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">block vpn / datacenter ips</div><div class="settings-desc">known hosting asns and vpn exit ranges flagged or blocked</div></div>
          <label class="toggle"><input type="checkbox" id="setVpn" ${site.settings.blockVpn?'checked':''} onchange="saveSetting('blockVpn',this.checked)"><span class="toggle-slider"></span></label>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head">token lifetime</div>
      <div class="settings-group-body">
        <div class="settings-row">
          <div><div class="settings-label">challenge ttl</div><div class="settings-desc">how long a verified token lasts before re-challenge</div></div>
          <div class="settings-ttl">
            <input type="number" class="ttl-input" id="setTtl" min="1" max="720" value="${site.settings.challengeTtl||24}">
            <span style="color:var(--muted);font-size:11px">hours</span>
            <button class="btn btn-ghost btn-sm" onclick="saveTtl()">save</button>
          </div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head">site status</div>
      <div class="settings-group-body">
        <div class="settings-row" style="border-bottom:none;padding-bottom:0">
          <div><div class="settings-label">active</div><div class="settings-desc">when off, all visitors pass through without any challenge</div></div>
          <label class="toggle"><input type="checkbox" id="setActive" ${site.active?'checked':''} onchange="saveActive(this.checked)"><span class="toggle-slider"></span></label>
        </div>
      </div>
    </div>
    <div class="danger-zone">
      <h4>danger zone</h4>
      <div style="margin-bottom:14px">
        <div class="settings-label" style="margin-bottom:4px">delete this site</div>
        <div class="settings-desc" style="margin-bottom:10px">permanently removes the site, its api key, and all request history.</div>
        <button class="btn btn-danger btn-sm" onclick="openDeleteSite()">delete site</button>
      </div>
      <div>
        <div class="settings-label" style="margin-bottom:4px">delete your account</div>
        <div class="settings-desc" style="margin-bottom:10px">deletes your account and all sites permanently. cannot be undone.</div>
        <button class="btn btn-danger btn-sm" onclick="openDeleteAccount()">delete account</button>
      </div>
    </div>
  `
}

function renderSitesGrid() {
  const grid = document.getElementById('sitesGrid')
  grid.innerHTML = sites.map(s => `
    <div class="site-card ${s.id===currentSiteId?'selected':''}" onclick="selectSite('${esc(s.id)}')">
      <div class="site-card-top">
        <div>
          <div class="site-card-name">${esc(s.name)}</div>
          <div class="site-card-domain">${esc(s.domain)}</div>
        </div>
        <span class="tag ${s.active?'tag-green':'tag-muted'}">${s.active?'active':'paused'}</span>
      </div>
      <div class="site-card-key">${esc(s.key)}</div>
    </div>
  `).join('') + `<div class="add-site-btn" onclick="openAddSite()"><span>+</span> add site</div>`
}

async function selectSite(id) {
  currentSiteId = id
  document.getElementById('siteSelect').value = id
  closeSidebar()
  await refreshData()
}

async function saveSetting(key, val) {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  site.settings[key] = val
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
  sites = sites.map(s => s.id===currentSiteId?site:s)
}

async function saveName() {
  const name = document.getElementById('settingName').value.trim()
  if (!name) return
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
  await loadSites()
}

async function saveTtl() {
  const ttl = parseInt(document.getElementById('setTtl').value)
  if (!ttl || ttl < 1) return
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  site.settings.challengeTtl = ttl
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
}

async function saveActive(val) {
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({active:val})})
  const site = sites.find(s => s.id === currentSiteId)
  if (site) site.active = val
}

function copyKey() {
  const site = sites.find(s => s.id === currentSiteId)
  if (site) navigator.clipboard.writeText(site.key)
}

async function rotateKey() {
  if (!confirm('rotate api key? all existing visitor tokens will be invalidated immediately.')) return
  const r = await fetch('/api/sites/'+currentSiteId+'/rotate',{method:'POST'})
  if (!r.ok) return
  const d = await r.json()
  const site = sites.find(s => s.id === currentSiteId)
  if (site) { site.key = d.key; renderInstall(site) }
}

function openDeleteSite() {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  const modal = document.getElementById('terminalModal')
  const cmd = `sudo delete brickwall-sites ${site.domain}`
  document.getElementById('terminalPrompt').textContent = '$ ' + cmd
  document.getElementById('terminalInput').value = ''
  document.getElementById('terminalError').style.display = 'none'
  modal.dataset.mode = 'site'
  modal.dataset.expected = cmd
  modal.classList.add('open')
  setTimeout(() => document.getElementById('terminalInput').focus(), 100)
}

function openDeleteAccount() {
  const modal = document.getElementById('terminalModal')
  const cmd = `sudo delete brickwall-accounts ${currentUser.email}`
  document.getElementById('terminalPrompt').textContent = '$ ' + cmd
  document.getElementById('terminalInput').value = ''
  document.getElementById('terminalError').style.display = 'none'
  modal.dataset.mode = 'account'
  modal.dataset.expected = cmd
  modal.classList.add('open')
  setTimeout(() => document.getElementById('terminalInput').focus(), 100)
}

function closeTerminalModal() {
  document.getElementById('terminalModal').classList.remove('open')
}

async function confirmTerminalDelete() {
  const modal = document.getElementById('terminalModal')
  const input = document.getElementById('terminalInput').value.trim()
  const expected = modal.dataset.expected
  const err = document.getElementById('terminalError')
  if (input !== expected) {
    err.textContent = 'command does not match. copy it exactly.'
    err.style.display = 'block'
    document.getElementById('terminalInput').style.animation = 'shake .3s ease'
    setTimeout(() => document.getElementById('terminalInput').style.animation = '', 300)
    return
  }
  const btn = document.getElementById('terminalConfirmBtn')
  btn.disabled = true; btn.textContent = 'deleting...'
  if (modal.dataset.mode === 'site') {
    await fetch('/api/sites/'+currentSiteId,{method:'DELETE'})
    modal.classList.remove('open')
    currentSiteId = null
    await loadSites()
    nav('sites')
  } else {
    await fetch('/api/auth/account',{method:'DELETE'})
    window.location.href = '/'
  }
  btn.disabled = false; btn.textContent = 'confirm delete'
}

function openAddSite() { document.getElementById('addSiteModal').classList.add('open') }
function closeAddSiteModal(e) { if (e.target===document.getElementById('addSiteModal')) document.getElementById('addSiteModal').classList.remove('open') }

async function doAddSite() {
  const name = document.getElementById('newSiteName').value.trim()
  const domain = document.getElementById('newSiteDomain').value.trim()
  const err = document.getElementById('addSiteError')
  err.style.display = 'none'
  if (!name||!domain) { err.textContent='fill in both fields'; err.style.display='block'; return }
  const btn = document.getElementById('addSiteBtn')
  btn.disabled=true; btn.textContent='adding...'
  const r = await fetch('/api/sites',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,domain})})
  if (!r.ok) {
    const d = await r.json()
    err.textContent = d.error||'failed to add site'
    err.style.display = 'block'
    btn.disabled=false; btn.textContent='add site →'
    return
  }
  const site = await r.json()
  document.getElementById('addSiteModal').classList.remove('open')
  document.getElementById('newSiteName').value=''
  document.getElementById('newSiteDomain').value=''
  btn.disabled=false; btn.textContent='add site →'
  currentSiteId = site.id
  await loadSites()
  nav('install')
}

const panelTitles = {
  overview:['overview',''],
  requests:['all requests','every verification attempt'],
  install:['installation','embed brickwall on your site'],
  settings:['site settings','configure protection options'],
  sites:['manage sites','add, switch, or remove sites'],
  account:['account','your profile and danger zone'],
}

function nav(page) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'))
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'))
  document.getElementById('panel-'+page).classList.add('active')
  document.getElementById('nav-'+page)?.classList.add('active')
  const [title,sub] = panelTitles[page]||[page,'']
  document.getElementById('pageTitle').textContent = title
  const site = sites.find(s=>s.id===currentSiteId)
  document.getElementById('pageSub').textContent = sub||(site?site.domain:'')
  if (page==='requests') renderAllTable()
  if (page==='sites') renderSitesGrid()
  if (page==='account') {
    document.getElementById('acctName').textContent = currentUser?.name || '—'
    document.getElementById('acctEmail').textContent = currentUser?.email || '—'
  }
  closeSidebar()
}

async function doLogout() {
  await fetch('/api/auth/logout',{method:'POST'})
  window.location.href = '/'
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')
}

init()
</script>
</body>
</html>
