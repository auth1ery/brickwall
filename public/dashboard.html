<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dashboard — brickwall</title>
<link rel="stylesheet" href="/css/shared.css">
<style>
body{display:flex;flex-direction:column;height:100vh;overflow:hidden}
#appShell{display:flex;flex:1;min-height:0;overflow:hidden}

#authWall{
  position:fixed;inset:0;background:var(--bg);z-index:9000;
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;
}
#authWall .logo{font-family:var(--display);font-size:20px;font-weight:800;letter-spacing:-.4px}
#authWall .logo span{color:var(--accent)}
#authWall p{color:var(--muted);font-size:12px}
#authWall.hidden{display:none}

.sidebar{
  width:220px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;
}
.sidebar-logo{
  padding:18px 16px 14px;border-bottom:1px solid var(--border);
  font-family:var(--display);font-size:16px;font-weight:800;letter-spacing:-.4px;
  display:flex;align-items:center;justify-content:space-between;
}
.sidebar-logo span{color:var(--accent)}
.sidebar-close{display:none;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1;padding:2px 4px}
.sidebar-section{padding:10px 10px 4px;font-size:9px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
.nav-item{
  display:flex;align-items:center;gap:9px;padding:9px 12px;margin:1px 6px;
  border-radius:3px;cursor:pointer;font-size:12px;color:var(--text2);
  transition:all .15s;border:1px solid transparent;
}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:var(--bg);border-color:var(--border);color:var(--text)}
.nav-item .icon{font-size:13px;width:16px;text-align:center;flex-shrink:0}

.site-picker{padding:10px 8px;border-bottom:1px solid var(--border)}
.site-select-wrap{position:relative}
.site-select-wrap select{
  padding-right:28px;cursor:pointer;appearance:none;
  font-size:11px;border-color:var(--border);color:var(--text);background:var(--bg);
}
.site-select-wrap::after{
  content:'▾';position:absolute;right:10px;top:50%;transform:translateY(-50%);
  color:var(--muted);pointer-events:none;font-size:10px;
}

.sidebar-bottom{margin-top:auto;border-top:1px solid var(--border);padding:10px 8px}
.user-chip{display:flex;align-items:center;gap:8px;padding:8px;border-radius:3px}
.user-avatar{
  width:28px;height:28px;border-radius:3px;background:var(--accent);
  display:flex;align-items:center;justify-content:center;font-size:11px;
  font-family:var(--display);font-weight:700;color:#fff;flex-shrink:0;
}
.user-info{min-width:0;flex:1}
.user-name{font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.user-email{font-size:10px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.logout-btn{
  background:none;border:none;color:var(--muted);font-size:10px;cursor:pointer;
  padding:4px 8px;font-family:var(--mono);transition:color .2s;display:block;width:100%;text-align:left;
}
.logout-btn:hover{color:var(--red)}

.main{flex:1;display:flex;flex-direction:column;min-width:0;min-height:0;overflow:hidden}
.topbar{
  padding:12px 20px;border-bottom:1px solid var(--border);display:flex;
  align-items:center;justify-content:space-between;flex-shrink:0;
  background:var(--bg);z-index:10;gap:10px;
}
.topbar-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
.menu-btn{
  display:none;background:none;border:1px solid var(--border);color:var(--text2);
  width:32px;height:32px;border-radius:3px;cursor:pointer;font-size:14px;
  align-items:center;justify-content:center;flex-shrink:0;
}
.page-title{font-family:var(--display);font-size:15px;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
.page-sub{color:var(--muted);font-size:11px;margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.content{padding:20px;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}

.panel{display:none}
.panel.active{display:block;animation:fadeIn .2s ease both}

.stat-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:14px 16px}
.sc-label{font-size:10px;color:var(--muted);letter-spacing:.04em;margin-bottom:6px}
.sc-value{font-family:var(--display);font-size:26px;font-weight:700;letter-spacing:-1px;line-height:1}
.sc-sub{font-size:10px;color:var(--muted);margin-top:4px}

.req-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:4px;overflow:hidden}
.req-table-head{
  padding:10px 14px;border-bottom:1px solid var(--border);display:flex;
  align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.req-table-head-title{font-family:var(--display);font-size:13px;font-weight:600}
.req-table-head-actions{display:flex;gap:8px;align-items:center}
.filter-input{width:160px;font-size:11px}
table{width:100%;border-collapse:collapse}
th{padding:8px 12px;text-align:left;font-size:9px;letter-spacing:.08em;color:var(--muted);font-weight:500;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap}
td{padding:9px 12px;font-size:11px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.02)}
.req-country{font-size:12px;font-weight:500}
.req-detected{font-size:10px;color:var(--muted)}
.req-ts{color:var(--muted);font-size:10px;white-space:nowrap}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted);font-size:12px;line-height:1.8}

.req-cards{display:none;flex-direction:column}
.req-card{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
.req-card:last-child{border-bottom:none}
.req-card-country{font-size:12px;font-weight:500;margin-bottom:3px}
.req-card-meta{font-size:10px;color:var(--muted)}
.req-card-right{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0}
.req-card-ts{font-size:10px;color:var(--muted)}

.install-wrap{max-width:660px}
.install-steps{display:flex;flex-direction:column;gap:0;margin-bottom:18px;background:var(--surface);border:1px solid var(--border);border-radius:4px;overflow:hidden}
.install-step{display:flex;gap:14px;padding:18px 16px;border-bottom:1px solid var(--border)}
.install-step:last-child{border-bottom:none}
.install-step-num{width:22px;height:22px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--muted);flex-shrink:0;font-family:var(--display);font-weight:700;margin-top:2px}
.install-step-title{font-family:var(--display);font-size:13px;font-weight:600;margin-bottom:7px}
.install-step-desc{color:var(--muted);font-size:11px;line-height:1.75;margin-bottom:10px}
.install-step-desc:last-child{margin-bottom:0}

.install-block{background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;overflow:hidden}
.install-block-head{padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--display);font-size:13px;font-weight:600}
.install-block-body{padding:14px}
.install-note{color:var(--muted);font-size:11px;line-height:1.75;margin-top:10px}

.code-block{
  background:var(--bg);border:1px solid var(--border2);border-radius:3px;
  padding:10px 12px;padding-top:32px;font-size:11px;color:var(--accent2);
  font-family:var(--mono);overflow-x:auto;white-space:pre;line-height:1.7;position:relative;
}
.code-copy{
  position:absolute;top:8px;right:8px;background:var(--surface);border:1px solid var(--border);
  color:var(--muted);padding:3px 10px;border-radius:2px;font-size:10px;cursor:pointer;
  font-family:var(--mono);transition:all .2s;
}
.code-copy:hover{border-color:var(--accent);color:var(--accent)}

.key-row{display:flex;align-items:center;gap:8px;background:var(--bg);border:1px solid var(--border2);border-radius:3px;padding:10px 12px;font-size:11px;font-family:var(--mono);color:var(--accent2);flex-wrap:wrap}
.key-val{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:120px}
.key-actions{display:flex;gap:6px;flex-shrink:0}

.settings-form{max-width:500px}
.settings-group{background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;overflow:hidden}
.settings-group-head{padding:11px 16px;border-bottom:1px solid var(--border);font-family:var(--display);font-size:13px;font-weight:600}
.settings-group-body{padding:14px 16px}
.settings-row{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding:10px 0;border-bottom:1px solid var(--border)}
.settings-row:last-child{border-bottom:none;padding-bottom:0}
.settings-row:first-child{padding-top:0}
.settings-label{font-size:12px;color:var(--text2)}
.settings-desc{font-size:10px;color:var(--muted);margin-top:3px;line-height:1.5;max-width:300px}
.toggle{position:relative;width:34px;height:19px;flex-shrink:0;margin-top:2px}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--border2);border-radius:10px;cursor:pointer;transition:.2s}
.toggle-slider::before{content:'';position:absolute;width:13px;height:13px;background:#fff;border-radius:50%;bottom:3px;left:3px;transition:.2s}
.toggle input:checked + .toggle-slider{background:var(--accent)}
.toggle input:checked + .toggle-slider::before{transform:translateX(15px)}
.settings-ttl{display:flex;align-items:center;gap:8px;margin-top:2px;flex-wrap:wrap}
.ttl-input{width:70px}

.sites-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.site-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px;cursor:pointer;transition:border-color .15s}
.site-card:hover{border-color:var(--border2)}
.site-card.selected{border-color:var(--accent)}
.site-card-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;gap:8px}
.site-card-name{font-family:var(--display);font-size:14px;font-weight:600;letter-spacing:-.3px}
.site-card-domain{color:var(--muted);font-size:11px;margin-top:2px}
.site-card-key{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.add-site-btn{background:var(--surface);border:1px dashed var(--border2);border-radius:4px;padding:16px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted);font-size:12px;min-height:100px}
.add-site-btn:hover{border-color:var(--accent);color:var(--accent)}

.empty-first{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:36px 24px;text-align:center;max-width:400px}
.empty-first h3{font-family:var(--display);font-size:17px;font-weight:700;margin-bottom:10px;letter-spacing:-.3px}
.empty-first p{color:var(--muted);font-size:12px;line-height:1.8;margin-bottom:20px}

.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);
  z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;
  opacity:0;pointer-events:none;transition:opacity .2s;
}
.modal-bg.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:5px;padding:24px;width:100%;max-width:360px;position:relative;transform:translateY(8px);transition:transform .2s}
.modal-bg.open .modal{transform:translateY(0)}
.modal h3{font-family:var(--display);font-size:17px;font-weight:700;margin-bottom:18px;letter-spacing:-.3px}
.modal .field{margin-bottom:14px}
.modal-close{position:absolute;top:10px;right:14px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1}
.modal-error{color:var(--red);font-size:11px;margin-top:8px;display:none}

.danger-zone{margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.danger-zone h4{font-family:var(--display);font-size:11px;font-weight:600;color:var(--red);margin-bottom:10px;letter-spacing:.06em;text-transform:uppercase}

.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:199}

.terminal-modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);
  z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;
  opacity:0;pointer-events:none;transition:opacity .15s;
}
.terminal-modal-bg.open{opacity:1;pointer-events:all}
.terminal-modal{
  background:var(--bg);border:1px solid var(--border2);border-radius:5px;
  width:100%;max-width:480px;overflow:hidden;
  transform:translateY(6px);transition:transform .15s;
}
.terminal-modal-bg.open .terminal-modal{transform:translateY(0)}
.terminal-header{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:10px 14px;display:flex;align-items:center;gap:8px;
}
.terminal-dot{width:10px;height:10px;border-radius:50%;background:var(--border2)}
.terminal-dot.red{background:#c44a3a}
.terminal-title{font-size:11px;color:var(--muted);margin-left:4px;font-family:var(--mono)}
.terminal-body{padding:18px}
.terminal-desc{font-size:11px;color:var(--text2);line-height:1.75;margin-bottom:16px}
.terminal-cmd-label{font-size:10px;color:var(--muted);margin-bottom:8px;letter-spacing:.04em}
.terminal-prompt{
  font-family:var(--mono);font-size:11px;color:var(--accent2);
  background:var(--surface);border:1px solid var(--border);border-radius:3px;
  padding:9px 12px;margin-bottom:14px;word-break:break-all;line-height:1.6;
  user-select:all;cursor:text;
}
.terminal-input-label{font-size:10px;color:var(--muted);margin-bottom:6px;letter-spacing:.04em}
.terminal-input-wrap{position:relative;display:flex;align-items:center;gap:0}
.terminal-caret{
  font-family:var(--mono);font-size:12px;color:var(--accent);padding:9px 0 9px 12px;
  background:var(--surface2);border:1px solid var(--border2);border-right:none;border-radius:3px 0 0 3px;
  flex-shrink:0;line-height:1;
}
.terminal-input{
  border-radius:0 3px 3px 0;border-left:none;background:var(--surface2);
  border-color:var(--border2);font-size:11px;color:var(--text);
}
.terminal-input:focus{border-color:var(--accent);outline:none;box-shadow:none}
.terminal-error{color:var(--red);font-size:11px;margin-top:8px;display:none}
.terminal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}

.req-detail-drawer{
  position:fixed;top:0;right:0;bottom:0;width:300px;
  background:var(--surface);border-left:1px solid var(--border2);
  z-index:500;display:flex;flex-direction:column;
  transform:translateX(100%);transition:transform .22s cubic-bezier(.4,0,.2,1);
  overflow:hidden;
}
.req-detail-drawer.open{transform:translateX(0)}
.req-detail-overlay{
  position:fixed;inset:0;z-index:499;
  background:rgba(0,0,0,0);pointer-events:none;transition:background .22s;
}
.req-detail-overlay.open{background:rgba(0,0,0,.35);pointer-events:all}
.req-detail-head{
  padding:14px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
}
.req-detail-title{font-family:var(--display);font-size:13px;font-weight:700;letter-spacing:-.2px}
.req-detail-close{
  background:none;border:1px solid var(--border);border-radius:3px;
  color:var(--muted);font-size:14px;width:26px;height:26px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  transition:all .15s;line-height:1;
}
.req-detail-close:hover{border-color:var(--border2);color:var(--text)}
.req-detail-body{padding:16px;overflow-y:auto;flex:1}
.req-detail-status{
  display:flex;align-items:center;justify-content:center;
  padding:20px 0 18px;border-bottom:1px solid var(--border);margin-bottom:16px;
}
.req-detail-status-inner{display:flex;flex-direction:column;align-items:center;gap:8px}
.req-detail-status-tag{font-size:13px;padding:5px 14px}
.req-detail-status-country{font-family:var(--display);font-size:22px;font-weight:700;letter-spacing:-.5px;text-align:center;margin-top:4px}
.req-detail-status-ts{font-size:10px;color:var(--muted);font-family:var(--mono);margin-top:2px}
.req-detail-section{margin-bottom:16px}
.req-detail-section-label{font-size:9px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px}
.req-detail-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:7px 0;border-bottom:1px solid var(--border)}
.req-detail-row:last-child{border-bottom:none}
.req-detail-key{font-size:11px;color:var(--muted);flex-shrink:0;padding-top:1px}
.req-detail-val{font-size:11px;color:var(--text2);text-align:right;word-break:break-word;max-width:170px}
.req-detail-val.mono{font-family:var(--mono);color:var(--accent2);font-size:10px}
.req-detail-ua-block{
  background:var(--bg);border:1px solid var(--border);border-radius:3px;
  padding:10px 12px;font-size:10px;font-family:var(--mono);color:var(--muted);
  line-height:1.7;word-break:break-all;margin-top:8px;
}
.req-detail-badge{
  display:inline-flex;align-items:center;gap:5px;
  background:var(--surface2);border:1px solid var(--border);border-radius:3px;
  padding:4px 8px;font-size:10px;color:var(--text2);margin:2px 2px 2px 0;
}
.req-detail-badge .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
tr.req-clickable{cursor:pointer}
tr.req-clickable:hover td{background:rgba(255,255,255,.04)}
tr.req-clickable.selected td{background:rgba(255,255,255,.05)}
.req-card.req-clickable{cursor:pointer}
.req-card.req-clickable:hover{background:rgba(255,255,255,.02)}
.req-card.selected{background:rgba(255,255,255,.03)}
@media(max-width:680px){
  .req-detail-drawer{width:100%;border-left:none;border-top:1px solid var(--border2);top:auto;height:75vh;transform:translateY(100%)}
  .req-detail-drawer.open{transform:translateY(0)}
}

.customize-group{background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;overflow:hidden}
.customize-group-head{padding:11px 16px;border-bottom:1px solid var(--border);font-family:var(--display);font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:space-between;gap:8px}
.customize-group-body{padding:14px 16px}
.customize-row{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 0;border-bottom:1px solid var(--border)}
.customize-row:last-child{border-bottom:none;padding-bottom:0}
.customize-row:first-child{padding-top:0}
.customize-label{font-size:12px;color:var(--text2)}
.customize-desc{font-size:10px;color:var(--muted);margin-top:3px;line-height:1.5}
.color-input-wrap{display:flex;align-items:center;gap:8px;flex-shrink:0}
.color-swatch{
  width:28px;height:28px;border-radius:3px;border:1px solid var(--border2);
  cursor:pointer;overflow:hidden;position:relative;flex-shrink:0;
}
.color-swatch input[type=color]{
  position:absolute;inset:-4px;width:calc(100%+8px);height:calc(100%+8px);
  opacity:0;cursor:pointer;border:none;padding:0;
}
.color-swatch-preview{position:absolute;inset:0;pointer-events:none;border-radius:2px}
.color-hex{width:74px;font-size:10px;font-family:var(--mono);color:var(--text2);background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:5px 8px;letter-spacing:.04em}
.color-hex:focus{outline:none;border-color:var(--accent)}

.preset-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-bottom:4px}
.preset-btn{
  background:var(--bg);border:1px solid var(--border);border-radius:3px;
  padding:9px 10px;cursor:pointer;transition:border-color .15s;
  display:flex;flex-direction:column;gap:6px;align-items:flex-start;
}
.preset-btn:hover{border-color:var(--border2)}
.preset-btn.active-preset{border-color:var(--accent)}
.preset-name{font-size:10px;color:var(--text2);font-family:var(--mono)}
.preset-swatches{display:flex;gap:3px}
.preset-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}

.font-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px}
.font-opt{
  background:var(--bg);border:1px solid var(--border);border-radius:3px;
  padding:10px 12px;cursor:pointer;transition:border-color .15s;
}
.font-opt:hover{border-color:var(--border2)}
.font-opt.active-font{border-color:var(--accent)}
.font-opt-name{font-size:11px;color:var(--text2);margin-bottom:3px}
.font-opt-sample{font-size:13px;color:var(--text);font-weight:700;letter-spacing:-.3px;line-height:1.2}

.customize-reset-btn{font-size:10px;color:var(--muted);background:none;border:1px solid var(--border);border-radius:3px;padding:4px 10px;cursor:pointer;font-family:var(--mono);transition:all .2s}
.customize-reset-btn:hover{border-color:var(--red);color:var(--red)}

.challenge-color-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0}
.challenge-color-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:9px 0;border-bottom:1px solid var(--border)}
.challenge-color-row:last-child{border-bottom:none}
.css-textarea{width:100%;min-height:120px;resize:vertical;font-family:var(--mono);font-size:10px;color:var(--accent2);background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:10px 12px;line-height:1.6;margin-top:2px;box-sizing:border-box}
.css-textarea:focus{outline:none;border-color:var(--accent)}
.challenge-text-input{font-size:11px;background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:6px 10px;color:var(--text);width:180px;flex-shrink:0}
.challenge-text-input:focus{outline:none;border-color:var(--accent)}
.challenge-preview-bar{display:flex;align-items:center;gap:8px;padding:10px 16px;border-top:1px solid var(--border);background:var(--surface2)}
.challenge-save-btn{font-size:11px}

.botlist-wrap{display:flex;flex-direction:column;gap:10px}
.botlist-input-row{display:flex;gap:6px;align-items:center}
.botlist-input{flex:1;font-size:11px}
.botlist-chips{display:flex;flex-wrap:wrap;gap:5px;min-height:24px}
.botlist-chip{
  display:inline-flex;align-items:center;gap:5px;
  background:var(--surface2);border:1px solid var(--border2);border-radius:3px;
  padding:3px 8px;font-size:10px;color:var(--text2);font-family:var(--mono);
}
.botlist-chip-remove{
  background:none;border:none;color:var(--muted);cursor:pointer;
  font-size:12px;line-height:1;padding:0 0 0 2px;
  transition:color .15s;
}
.botlist-chip-remove:hover{color:var(--red)}
.botlist-empty{font-size:10px;color:var(--muted);font-style:italic}
.botlist-tabs{display:flex;gap:0;border:1px solid var(--border);border-radius:3px;overflow:hidden;margin-bottom:12px}
.botlist-tab{
  flex:1;padding:7px 10px;font-size:10px;font-family:var(--mono);color:var(--muted);
  background:var(--bg);border:none;cursor:pointer;transition:all .15s;text-align:center;
}
.botlist-tab:first-child{border-right:1px solid var(--border)}
.botlist-tab.active-tab{background:var(--surface2);color:var(--text)}
.botlist-tab-panel{display:none}
.botlist-tab-panel.active-tab-panel{display:block}
.botlist-hint{font-size:10px;color:var(--muted);line-height:1.6;margin-bottom:8px}
.known-bots-grid{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
.known-bot-btn{
  background:var(--bg);border:1px solid var(--border);border-radius:3px;
  padding:3px 8px;font-size:10px;font-family:var(--mono);color:var(--muted);
  cursor:pointer;transition:all .15s;
}
.known-bot-btn:hover{border-color:var(--accent);color:var(--accent)}

.sidebar-density-opt{display:flex;gap:6px;flex-shrink:0}
.density-btn{background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:5px 12px;font-size:10px;color:var(--muted);cursor:pointer;font-family:var(--mono);transition:all .15s}
.density-btn:hover{border-color:var(--border2);color:var(--text2)}
.density-btn.active-density{border-color:var(--accent);color:var(--accent)}

body.density-compact .nav-item{padding:6px 12px}
body.density-compact .settings-row{padding:7px 0}
body.density-compact .customize-row{padding:7px 0}
body.density-compact .stat-card{padding:10px 12px}
body.density-compact .sc-value{font-size:22px}
body.density-compact td{padding:7px 12px}
body.density-compact .install-step{padding:12px 14px}

body.density-spacious .nav-item{padding:12px 14px}
body.density-spacious .settings-row{padding:14px 0}
body.density-spacious .customize-row{padding:14px 0}
body.density-spacious .stat-card{padding:20px 22px}
body.density-spacious .sc-value{font-size:30px}
body.density-spacious td{padding:12px 14px}

@media(max-width:900px){.stat-cards{grid-template-columns:repeat(2,1fr)}}
@media(max-width:680px){
  .sidebar{position:fixed;left:-240px;top:0;bottom:0;width:240px;z-index:200;transition:left .25s ease}
  .sidebar.open{left:0;box-shadow:4px 0 24px rgba(0,0,0,.5)}
  .sidebar-close{display:block}
  .sidebar-overlay.open{display:block}
  .menu-btn{display:flex}
  .main{min-height:0}
  .content{padding:14px}
  table{display:none}
  .req-cards{display:flex}
  .filter-input{width:120px}
  .install-wrap,.settings-form{max-width:100%}
  .code-block{font-size:10px}
  .sites-grid{grid-template-columns:1fr}
  .key-actions{width:100%}
  .key-actions .btn{flex:1;justify-content:center}
  .settings-ttl{gap:6px}
  .preset-grid{grid-template-columns:repeat(3,1fr)}
  .font-grid{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:440px){
  .stat-cards{grid-template-columns:1fr 1fr}
  .sc-value{font-size:22px}
  .topbar{padding:10px 14px}
  .content{padding:12px}
}
</style>
</head>
<body>
<div class="noise"></div>

<div id="authWall">
  <div class="logo">brick<span>wall</span></div>
  <div class="spinner"></div>
  <p>loading...</p>
</div>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div id="appShell" style="display:none">
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    brick<span>wall</span>
    <button class="sidebar-close" onclick="closeSidebar()">×</button>
  </div>
  <div class="site-picker">
    <label>active site</label>
    <div class="site-select-wrap">
      <select id="siteSelect" onchange="onSiteChange()"><option value="">no sites yet</option></select>
    </div>
  </div>
  <div class="sidebar-section">overview</div>
  <div class="nav-item active" onclick="nav('overview')" id="nav-overview"><span class="icon">▦</span> overview</div>
  <div class="nav-item" onclick="nav('requests')" id="nav-requests"><span class="icon">◈</span> all requests</div>
  <div class="sidebar-section">setup</div>
  <div class="nav-item" onclick="nav('install')" id="nav-install"><span class="icon">⌥</span> installation</div>
  <div class="nav-item" onclick="nav('settings')" id="nav-settings"><span class="icon">⚙</span> site settings</div>
  <div class="sidebar-section">account</div>
  <div class="nav-item" onclick="nav('sites')" id="nav-sites"><span class="icon">◫</span> manage sites</div>
  <div class="nav-item" onclick="nav('account')" id="nav-account"><span class="icon">⊘</span> account</div>
  <div class="sidebar-bottom">
    <div class="user-chip">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-info">
        <div class="user-name" id="userName">loading...</div>
        <div class="user-email" id="userEmail"></div>
      </div>
    </div>
    <button class="logout-btn" onclick="doLogout()">→ log out</button>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div class="topbar-left">
      <button class="menu-btn" onclick="openSidebar()">☰</button>
      <div>
        <div class="page-title" id="pageTitle">overview</div>
        <div class="page-sub" id="pageSub">loading...</div>
      </div>
    </div>
    <div id="topbarActions"></div>
  </div>
  <div class="content">

    <div class="panel active" id="panel-overview">
      <div class="stat-cards" id="statCards">
        <div class="stat-card"><div class="sc-label">total requests</div><div class="sc-value">—</div></div>
        <div class="stat-card"><div class="sc-label">passed</div><div class="sc-value">—</div></div>
        <div class="stat-card"><div class="sc-label">blocked</div><div class="sc-value">—</div></div>
        <div class="stat-card"><div class="sc-label">flagged</div><div class="sc-value">—</div></div>
      </div>
      <div class="req-table-wrap" id="overviewTableWrap">
        <div class="req-table-head">
          <div class="req-table-head-title">recent requests</div>
          <button class="btn btn-ghost btn-sm" onclick="nav('requests')">view all →</button>
        </div>
        <div id="recentReqsTable"></div>
        <div class="req-cards" id="recentReqCards"></div>
      </div>
    </div>

    <div class="panel" id="panel-requests">
      <div class="req-table-wrap">
        <div class="req-table-head">
          <div class="req-table-head-title">all requests</div>
          <div class="req-table-head-actions">
            <input class="filter-input" type="text" placeholder="filter..." oninput="filterReqs(this.value)" id="reqFilter">
            <button class="btn btn-ghost btn-sm" onclick="loadRequests()">↻</button>
          </div>
        </div>
        <div id="allReqsTable"></div>
        <div class="req-cards" id="allReqCards"></div>
      </div>
    </div>

    <div class="panel" id="panel-install">
      <div class="install-wrap" id="installWrap">
        <div class="empty-state">select or add a site to see installation instructions.</div>
      </div>
    </div>

    <div class="panel" id="panel-settings">
      <div class="settings-form" id="settingsWrap">
        <div class="empty-state">select a site to configure its settings.</div>
      </div>
    </div>

    <div class="panel" id="panel-sites">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-family:var(--display);font-size:15px;font-weight:700">all sites</div>
          <div style="color:var(--muted);font-size:11px;margin-top:2px">manage all your protected sites</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openAddSite()">+ add site</button>
      </div>
      <div class="sites-grid" id="sitesGrid"></div>
    </div>

    <div class="panel" id="panel-account">
      <div class="settings-form">
        <div class="settings-group">
          <div class="settings-group-head">account info</div>
          <div class="settings-group-body">
            <div class="settings-row">
              <div><div class="settings-label">name</div></div>
              <div style="font-size:12px;color:var(--text2)" id="acctName">—</div>
            </div>
            <div class="settings-row" style="border-bottom:none;padding-bottom:0">
              <div><div class="settings-label">email</div></div>
              <div style="font-size:12px;color:var(--text2)" id="acctEmail">—</div>
            </div>
          </div>
        </div>

        <div style="font-family:var(--display);font-size:15px;font-weight:700;margin:20px 0 12px;letter-spacing:-.3px">customize dashboard</div>

        <div class="customize-group">
          <div class="customize-group-head">
            <span>presets</span>
            <button class="customize-reset-btn" onclick="resetCustomize()">reset to default</button>
          </div>
          <div class="customize-group-body">
            <div class="preset-grid" id="presetGrid"></div>
          </div>
        </div>

        <div class="customize-group">
          <div class="customize-group-head">colors</div>
          <div class="customize-group-body" id="colorRows"></div>
        </div>

        <div class="customize-group">
          <div class="customize-group-head">typography</div>
          <div class="customize-group-body">
            <div class="customize-row" style="padding-bottom:12px;border-bottom:none">
              <div><div class="customize-label">display font</div><div class="customize-desc">used for headings, numbers, and ui labels</div></div>
            </div>
            <div class="font-grid" id="fontGrid"></div>
          </div>
        </div>

        <div class="customize-group">
          <div class="customize-group-head">density</div>
          <div class="customize-group-body">
            <div class="customize-row" style="border-bottom:none;padding-bottom:0">
              <div><div class="customize-label">layout density</div><div class="customize-desc">controls padding and spacing throughout the ui</div></div>
              <div class="sidebar-density-opt" id="densityBtns">
                <button class="density-btn" onclick="setDensity('compact')">compact</button>
                <button class="density-btn active-density" onclick="setDensity('default')">default</button>
                <button class="density-btn" onclick="setDensity('spacious')">spacious</button>
              </div>
            </div>
          </div>
        </div>

        <div class="danger-zone">
          <h4>danger zone</h4>
          <div>
            <div class="settings-label" style="margin-bottom:4px">delete your account</div>
            <div class="settings-desc" style="margin-bottom:10px">permanently deletes your account, all sites, all api keys, and all request history. there is no going back.</div>
            <button class="btn btn-danger btn-sm" onclick="openDeleteAccount()">delete account</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>
</div>

<div class="req-detail-overlay" id="reqDetailOverlay" onclick="closeReqDetail()"></div>
<div class="req-detail-drawer" id="reqDetailDrawer">
  <div class="req-detail-head">
    <div class="req-detail-title">request detail</div>
    <button class="req-detail-close" onclick="closeReqDetail()">×</button>
  </div>
  <div class="req-detail-body" id="reqDetailBody"></div>
</div>

<div class="modal-bg" id="addSiteModal" onclick="closeAddSiteModal(event)">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('addSiteModal').classList.remove('open')">×</button>
    <h3>add a new site</h3>
    <div class="field"><label>site name</label><input type="text" id="newSiteName" placeholder="my blog" autocomplete="off"></div>
    <div class="field"><label>domain</label><input type="url" id="newSiteDomain" placeholder="https://yoursite.com" autocomplete="off"></div>
    <div class="modal-error" id="addSiteError"></div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px;justify-content:center" onclick="doAddSite()" id="addSiteBtn">add site →</button>
  </div>
</div>

<div class="terminal-modal-bg" id="terminalModal" onclick="if(event.target===this)closeTerminalModal()">
  <div class="terminal-modal">
    <div class="terminal-header">
      <div class="terminal-dot red"></div>
      <div class="terminal-dot"></div>
      <div class="terminal-dot"></div>
      <span class="terminal-title">confirm destructive action</span>
    </div>
    <div class="terminal-body">
      <p class="terminal-desc">this action is <strong style="color:var(--red)">permanent and cannot be undone</strong>. type the command below exactly to confirm.</p>
      <div class="terminal-cmd-label">command to run</div>
      <div class="terminal-prompt" id="terminalPrompt" onclick="navigator.clipboard.writeText(this.textContent.slice(2))">$ ...</div>
      <div class="terminal-input-label">type the command to confirm</div>
      <div class="terminal-input-wrap">
        <span class="terminal-caret">$</span>
        <input class="terminal-input" type="text" id="terminalInput" placeholder="type command here..." autocomplete="off" spellcheck="false" onkeydown="if(event.key==='Enter')confirmTerminalDelete();if(event.key==='Escape')closeTerminalModal()">
      </div>
      <div class="terminal-error" id="terminalError"></div>
      <div class="terminal-actions">
        <button class="btn btn-ghost btn-sm" onclick="closeTerminalModal()">cancel</button>
        <button class="btn btn-danger btn-sm" id="terminalConfirmBtn" onclick="confirmTerminalDelete()">confirm delete</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentUser = null
let sites = []
let currentSiteId = null
let allRequests = []
let filteredRequests = []
let activeReqList = []

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeReqDetail() })

const CUSTOMIZE_KEY = 'bw_customize'

const COLOR_VARS = [
  { key: '--bg', label: 'background', desc: 'main page background' },
  { key: '--surface', label: 'surface', desc: 'cards, panels, sidebar' },
  { key: '--surface2', label: 'surface 2', desc: 'table headers, inputs' },
  { key: '--accent', label: 'accent', desc: 'primary brand color' },
  { key: '--accent2', label: 'accent 2', desc: 'code and key text color' },
  { key: '--text', label: 'text', desc: 'primary text color' },
  { key: '--text2', label: 'text secondary', desc: 'labels and secondary text' },
  { key: '--muted', label: 'muted', desc: 'placeholder and dim text' },
  { key: '--border', label: 'border', desc: 'standard borders' },
  { key: '--border2', label: 'border 2', desc: 'focused / stronger borders' },
  { key: '--green', label: 'passed color', desc: 'passed tag and stats' },
  { key: '--red', label: 'blocked / danger', desc: 'blocked tag, delete actions' },
  { key: '--yellow', label: 'flagged color', desc: 'flagged tag and warnings' },
]

const PRESETS = [
  {
    id: 'default',
    name: 'default',
    colors: {
      '--bg': '#0d0d0d',
      '--surface': '#131313',
      '--surface2': '#181818',
      '--accent': '#d95f2b',
      '--accent2': '#c8a97e',
      '--text': '#e8e4de',
      '--text2': '#a89f95',
      '--muted': '#5a5450',
      '--border': '#222',
      '--border2': '#333',
      '--green': '#4a8a5c',
      '--red': '#c44a3a',
      '--yellow': '#b58a3a',
    },
    font: 'default'
  },
  {
    id: 'slate',
    name: 'slate',
    colors: {
      '--bg': '#0f1117',
      '--surface': '#161b27',
      '--surface2': '#1c2235',
      '--accent': '#6366f1',
      '--accent2': '#818cf8',
      '--text': '#e2e8f0',
      '--text2': '#94a3b8',
      '--muted': '#475569',
      '--border': '#1e2a3a',
      '--border2': '#2d3c50',
      '--green': '#22c55e',
      '--red': '#ef4444',
      '--yellow': '#eab308',
    },
    font: 'default'
  },
  {
    id: 'chalk',
    name: 'chalk',
    colors: {
      '--bg': '#f5f2ee',
      '--surface': '#ebe7e1',
      '--surface2': '#ddd9d2',
      '--accent': '#c0392b',
      '--accent2': '#8b4513',
      '--text': '#1a1614',
      '--text2': '#4a3f38',
      '--muted': '#8a7f78',
      '--border': '#ccc8c0',
      '--border2': '#b0aba3',
      '--green': '#2d6a4f',
      '--red': '#c0392b',
      '--yellow': '#b7791f',
    },
    font: 'mono'
  },
  {
    id: 'forest',
    name: 'forest',
    colors: {
      '--bg': '#0e1a14',
      '--surface': '#132018',
      '--surface2': '#1a2b20',
      '--accent': '#4ade80',
      '--accent2': '#86efac',
      '--text': '#dcfce7',
      '--text2': '#86efac',
      '--muted': '#3d6b4f',
      '--border': '#1f3329',
      '--border2': '#2d4a38',
      '--green': '#4ade80',
      '--red': '#f87171',
      '--yellow': '#fbbf24',
    },
    font: 'default'
  },
  {
    id: 'noir',
    name: 'noir',
    colors: {
      '--bg': '#050505',
      '--surface': '#0a0a0a',
      '--surface2': '#111',
      '--accent': '#ffffff',
      '--accent2': '#cccccc',
      '--text': '#ffffff',
      '--text2': '#aaaaaa',
      '--muted': '#444444',
      '--border': '#1a1a1a',
      '--border2': '#282828',
      '--green': '#888888',
      '--red': '#cccccc',
      '--yellow': '#999999',
    },
    font: 'mono'
  },
  {
    id: 'synthwave',
    name: 'synthwave',
    colors: {
      '--bg': '#0d0221',
      '--surface': '#130432',
      '--surface2': '#1a0845',
      '--accent': '#ff2d78',
      '--accent2': '#00f5ff',
      '--text': '#f0e6ff',
      '--text2': '#c084fc',
      '--muted': '#6b3fa0',
      '--border': '#2a0d5e',
      '--border2': '#3d1a80',
      '--green': '#39ff14',
      '--red': '#ff2d78',
      '--yellow': '#ffdd00',
    },
    font: 'default'
  },
]

const FONTS = [
  { id: 'default', name: 'default', family: 'inherit', sample: 'Brickwall' },
  { id: 'mono', name: 'monospace', family: 'var(--mono)', sample: 'Brickwall' },
  { id: 'serif', name: 'serif', family: 'Georgia, "Times New Roman", serif', sample: 'Brickwall' },
  { id: 'system', name: 'system ui', family: 'system-ui, -apple-system, sans-serif', sample: 'Brickwall' },
  { id: 'rounded', name: 'rounded', family: '"Trebuchet MS", Optima, Candara, sans-serif', sample: 'Brickwall' },
  { id: 'slab', name: 'slab', family: '"Rockwell", "Courier New", monospace', sample: 'Brickwall' },
]

let customizeState = {}

function loadCustomize() {
  try {
    const raw = localStorage.getItem(CUSTOMIZE_KEY)
    if (raw) customizeState = JSON.parse(raw)
  } catch { customizeState = {} }
  applyCustomize()
}

function saveCustomize() {
  localStorage.setItem(CUSTOMIZE_KEY, JSON.stringify(customizeState))
}

function applyCustomize() {
  const root = document.documentElement
  if (customizeState.colors) {
    Object.entries(customizeState.colors).forEach(([k, v]) => root.style.setProperty(k, v))
  }
  if (customizeState.font) {
    const f = FONTS.find(x => x.id === customizeState.font)
    if (f) root.style.setProperty('--display', f.family)
  }
  if (customizeState.density) {
    document.body.classList.remove('density-compact', 'density-spacious')
    if (customizeState.density !== 'default') document.body.classList.add('density-' + customizeState.density)
  }
}

function resetCustomize() {
  customizeState = {}
  localStorage.removeItem(CUSTOMIZE_KEY)
  const root = document.documentElement
  COLOR_VARS.forEach(v => root.style.removeProperty(v.key))
  root.style.removeProperty('--display')
  document.body.classList.remove('density-compact', 'density-spacious')
  renderCustomizePanel()
}

function getComputedColor(varName) {
  if (customizeState.colors && customizeState.colors[varName]) return customizeState.colors[varName]
  return rgbToHex(getComputedStyle(document.documentElement).getPropertyValue(varName).trim())
}

function rgbToHex(val) {
  if (!val) return '#000000'
  if (val.startsWith('#')) return val.length === 4
    ? '#' + val[1]+val[1]+val[2]+val[2]+val[3]+val[3]
    : val
  const m = val.match(/\d+/g)
  if (!m || m.length < 3) return '#000000'
  return '#' + m.slice(0,3).map(n => parseInt(n).toString(16).padStart(2,'0')).join('')
}

function setColor(varName, hexVal) {
  if (!customizeState.colors) customizeState.colors = {}
  customizeState.colors[varName] = hexVal
  document.documentElement.style.setProperty(varName, hexVal)
  saveCustomize()
  syncColorRow(varName, hexVal)
}

function syncColorRow(varName, hexVal) {
  const swatch = document.querySelector('[data-swatch="'+varName+'"]')
  if (swatch) swatch.style.background = hexVal
  const hexInput = document.querySelector('[data-hexinput="'+varName+'"]')
  if (hexInput && document.activeElement !== hexInput) hexInput.value = hexVal
  const colorInput = document.querySelector('[data-colorinput="'+varName+'"]')
  if (colorInput) colorInput.value = hexVal
  updateActivePreset()
}

function setFont(fontId) {
  customizeState.font = fontId
  const f = FONTS.find(x => x.id === fontId)
  if (f) document.documentElement.style.setProperty('--display', f.family)
  saveCustomize()
  renderFontGrid()
}

function setDensity(d) {
  customizeState.density = d
  document.body.classList.remove('density-compact', 'density-spacious')
  if (d !== 'default') document.body.classList.add('density-' + d)
  saveCustomize()
  document.querySelectorAll('.density-btn').forEach(b => b.classList.remove('active-density'))
  document.querySelectorAll('.density-btn').forEach(b => {
    if (b.textContent.trim() === d) b.classList.add('active-density')
  })
}

function applyPreset(presetId) {
  const p = PRESETS.find(x => x.id === presetId)
  if (!p) return
  customizeState.colors = Object.assign({}, p.colors)
  customizeState.font = p.font
  if (!customizeState.density) customizeState.density = 'default'
  applyCustomize()
  saveCustomize()
  renderCustomizePanel()
}

function updateActivePreset() {
  document.querySelectorAll('.preset-btn').forEach(btn => {
    const pid = btn.dataset.preset
    const p = PRESETS.find(x => x.id === pid)
    if (!p) return
    const isActive = COLOR_VARS.every(cv => {
      const cur = customizeState.colors?.[cv.key]
      return !cur || cur.toLowerCase() === p.colors[cv.key].toLowerCase()
    })
    btn.classList.toggle('active-preset', isActive)
  })
}

function renderPresetGrid() {
  const grid = document.getElementById('presetGrid')
  grid.innerHTML = PRESETS.map(p => {
    const swatchKeys = ['--bg','--surface','--accent','--accent2','--text']
    const dots = swatchKeys.map(k => `<div class="preset-dot" style="background:${p.colors[k]}"></div>`).join('')
    const isActive = customizeState.colors
      ? COLOR_VARS.every(cv => !customizeState.colors[cv.key] || customizeState.colors[cv.key].toLowerCase() === p.colors[cv.key].toLowerCase())
      : p.id === 'default'
    return `<button class="preset-btn ${isActive?'active-preset':''}" data-preset="${p.id}" onclick="applyPreset('${p.id}')">
      <div class="preset-swatches">${dots}</div>
      <div class="preset-name">${p.name}</div>
    </button>`
  }).join('')
}

function renderColorRows() {
  const wrap = document.getElementById('colorRows')
  wrap.innerHTML = COLOR_VARS.map(cv => {
    const hex = getComputedColor(cv.key)
    return `<div class="customize-row">
      <div>
        <div class="customize-label">${cv.label}</div>
        <div class="customize-desc">${cv.desc}</div>
      </div>
      <div class="color-input-wrap">
        <div class="color-swatch" title="click to pick color">
          <div class="color-swatch-preview" data-swatch="${cv.key}" style="background:${hex}"></div>
          <input type="color" value="${hex}" data-colorinput="${cv.key}"
            oninput="setColor('${cv.key}',this.value);syncColorRow('${cv.key}',this.value)"
            onchange="setColor('${cv.key}',this.value)">
        </div>
        <input class="color-hex" type="text" value="${hex}" maxlength="7" data-hexinput="${cv.key}"
          oninput="onHexInput('${cv.key}',this)"
          onblur="onHexBlur('${cv.key}',this)">
      </div>
    </div>`
  }).join('')
}

function onHexInput(varName, input) {
  const v = input.value.trim()
  if (/^#[0-9a-fA-F]{6}$/.test(v)) {
    setColor(varName, v)
    const ci = document.querySelector('[data-colorinput="'+varName+'"]')
    if (ci) ci.value = v
    const sw = document.querySelector('[data-swatch="'+varName+'"]')
    if (sw) sw.style.background = v
  }
}

function onHexBlur(varName, input) {
  const v = input.value.trim()
  if (!/^#[0-9a-fA-F]{6}$/.test(v)) input.value = getComputedColor(varName)
}

function renderFontGrid() {
  const grid = document.getElementById('fontGrid')
  const active = customizeState.font || 'default'
  grid.innerHTML = FONTS.map(f => `
    <div class="font-opt ${f.id===active?'active-font':''}" onclick="setFont('${f.id}')">
      <div class="font-opt-name">${f.name}</div>
      <div class="font-opt-sample" style="font-family:${f.family}">${f.sample}</div>
    </div>
  `).join('')
}

function renderDensityBtns() {
  const active = customizeState.density || 'default'
  document.querySelectorAll('.density-btn').forEach(b => {
    b.classList.toggle('active-density', b.textContent.trim() === active)
  })
}

function renderCustomizePanel() {
  renderPresetGrid()
  renderColorRows()
  renderFontGrid()
  renderDensityBtns()
}

async function init() {
  loadCustomize()
  try {
    const r = await fetch('/api/auth/me')
    if (!r.ok) { window.location.href = '/'; return }
    currentUser = await r.json()
    document.getElementById('userName').textContent = currentUser.name
    document.getElementById('userEmail').textContent = currentUser.email
    document.getElementById('userAvatar').textContent = currentUser.name[0].toUpperCase()
    document.getElementById('authWall').classList.add('hidden')
    document.getElementById('appShell').style.display = 'flex'
    await loadSites()
  } catch { window.location.href = '/' }
}

function openSidebar() {
  document.getElementById('sidebar').classList.add('open')
  document.getElementById('sidebarOverlay').classList.add('open')
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open')
  document.getElementById('sidebarOverlay').classList.remove('open')
}

async function loadSites() {
  const r = await fetch('/api/sites')
  if (!r.ok) return
  sites = await r.json()
  const sel = document.getElementById('siteSelect')
  sel.innerHTML = ''
  if (sites.length === 0) {
    sel.innerHTML = '<option value="">no sites yet</option>'
    showNoSites()
    return
  }
  sites.forEach(s => {
    const o = document.createElement('option')
    o.value = s.id
    o.textContent = s.name + ' (' + s.domain + ')'
    sel.appendChild(o)
  })
  if (!currentSiteId || !sites.find(s => s.id === currentSiteId)) currentSiteId = sites[0].id
  sel.value = currentSiteId
  await refreshData()
}

function showNoSites() {
  document.getElementById('pageSub').textContent = 'add your first site to get started'
  document.getElementById('statCards').innerHTML = `
    <div class="stat-card"><div class="sc-label">total requests</div><div class="sc-value" style="color:var(--muted)">0</div></div>
    <div class="stat-card"><div class="sc-label">passed</div><div class="sc-value" style="color:var(--muted)">0</div></div>
    <div class="stat-card"><div class="sc-label">blocked</div><div class="sc-value" style="color:var(--muted)">0</div></div>
    <div class="stat-card"><div class="sc-label">flagged</div><div class="sc-value" style="color:var(--muted)">0</div></div>
  `
  document.getElementById('overviewTableWrap').style.display = 'none'
  const existing = document.getElementById('emptyFirst')
  if (!existing) {
    document.getElementById('panel-overview').insertAdjacentHTML('beforeend', `
      <div class="empty-first" id="emptyFirst">
        <h3>add your first site</h3>
        <p>connect a site to start protecting it. you'll get a unique api key and a one-line script tag to drop into your html.</p>
        <button class="btn btn-primary" style="margin:0 auto" onclick="openAddSite()">+ add site</button>
      </div>
    `)
  }
}

async function onSiteChange() {
  currentSiteId = document.getElementById('siteSelect').value
  allRequests = []
  await refreshData()
}

async function refreshData() {
  if (!currentSiteId) return
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  document.getElementById('pageSub').textContent = site.domain
  const ef = document.getElementById('emptyFirst')
  if (ef) ef.remove()
  document.getElementById('overviewTableWrap').style.display = ''
  await Promise.all([loadStats(), loadRequests(), renderInstall(site), renderSettings(site)])
  renderSitesGrid()
  renderBotAllowlist(site)
}

async function loadStats() {
  const r = await fetch('/api/sites/' + currentSiteId + '/stats')
  if (!r.ok) return
  const d = await r.json()
  document.getElementById('statCards').innerHTML = `
    <div class="stat-card"><div class="sc-label">total requests</div><div class="sc-value">${d.total}</div><div class="sc-sub">all time</div></div>
    <div class="stat-card"><div class="sc-label">passed</div><div class="sc-value" style="color:var(--green)">${d.passed}</div><div class="sc-sub">${d.total?Math.round(d.passed/d.total*100):0}% rate</div></div>
    <div class="stat-card"><div class="sc-label">blocked</div><div class="sc-value" style="color:var(--red)">${d.blocked}</div><div class="sc-sub">bots stopped</div></div>
    <div class="stat-card"><div class="sc-label">flagged</div><div class="sc-value" style="color:var(--yellow)">${d.flagged}</div><div class="sc-sub">suspicious</div></div>
  `
}

async function loadRequests() {
  const r = await fetch('/api/sites/' + currentSiteId + '/requests')
  if (!r.ok) return
  allRequests = await r.json()
  filteredRequests = [...allRequests]
  renderRecentTable()
  renderAllTable()
}

function renderRecentTable() {
  const recent = allRequests.slice(0, 10)
  activeReqList = recent
  document.getElementById('recentReqsTable').innerHTML = buildTable(recent)
  document.getElementById('recentReqCards').innerHTML = buildCards(recent)
}

function renderAllTable() {
  activeReqList = filteredRequests
  document.getElementById('allReqsTable').innerHTML = buildTable(filteredRequests)
  document.getElementById('allReqCards').innerHTML = buildCards(filteredRequests)
}

function filterReqs(val) {
  const v = val.toLowerCase()
  filteredRequests = allRequests.filter(r =>
    r.country.toLowerCase().includes(v) || r.status.includes(v) || r.detected.includes(v)
  )
  renderAllTable()
}

function buildTable(reqs) {
  if (!reqs.length) return '<div class="empty-state">no requests yet.<br>embed the script on your site and visits will show up here.</div>'
  return `<table><thead><tr><th>location</th><th>detected as</th><th>status</th><th>time</th></tr></thead><tbody>${
    reqs.map((r,i) => `<tr class="req-clickable" onclick="openReqDetail(${i},this)" data-idx="${i}">
      <td><span class="req-country">${esc(r.country)}</span></td>
      <td><span class="req-detected">${r.detected==='N/A'?'—':esc(r.detected)}</span></td>
      <td>${stag(r.status)}</td>
      <td class="req-ts">${fmt(r.ts)}</td>
    </tr>`).join('')
  }</tbody></table>`
}

function buildCards(reqs) {
  if (!reqs.length) return '<div class="empty-state">no requests yet.<br>embed the script on your site and visits will show up here.</div>'
  return reqs.map((r,i) => `<div class="req-card req-clickable" onclick="openReqDetail(${i},this)" data-idx="${i}">
    <div>
      <div class="req-card-country">${esc(r.country)}</div>
      <div class="req-card-meta">detected: ${r.detected==='N/A'?'—':esc(r.detected)}</div>
    </div>
    <div class="req-card-right">${stag(r.status)}<div class="req-card-ts">${fmt(r.ts)}</div></div>
  </div>`).join('')
}

function stag(s) {
  const m={passed:'tag-green',blocked:'tag-red',flagged:'tag-yellow'}
  return `<span class="tag ${m[s]||'tag-muted'}">${s}</span>`
}

function fmt(ts) {
  const d=new Date(ts)
  return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes())
}
function p(n){return String(n).padStart(2,'0')}

function fmtFull(ts) {
  const d = new Date(ts)
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
  return days[d.getDay()]+', '+months[d.getMonth()]+' '+d.getDate()+' '+d.getFullYear()+
    ' at '+p(d.getHours())+':'+p(d.getMinutes())+':'+p(d.getSeconds())
}

function parseUA(ua) {
  if (!ua) return { browser: 'Unknown', os: 'Unknown', device: 'Unknown', raw: '' }
  const s = ua
  let browser = 'Unknown', os = 'Unknown', device = 'desktop'

  if (/HeadlessChrome/i.test(s)) browser = 'Headless Chrome'
  else if (/Edg\//i.test(s)) browser = 'Edge '+(/Edg\/([0-9]+)/.exec(s)||['','?'])[1]
  else if (/OPR\/|Opera/i.test(s)) browser = 'Opera'
  else if (/Firefox\/([0-9]+)/i.test(s)) browser = 'Firefox '+(s.match(/Firefox\/([0-9]+)/i)||['','?'])[1]
  else if (/Chrome\/([0-9]+)/i.test(s) && !/Chromium/i.test(s)) browser = 'Chrome '+(s.match(/Chrome\/([0-9]+)/i)||['','?'])[1]
  else if (/Chromium\/([0-9]+)/i.test(s)) browser = 'Chromium '+(s.match(/Chromium\/([0-9]+)/i)||['','?'])[1]
  else if (/Safari\/([0-9]+)/i.test(s) && !/Chrome/i.test(s)) browser = 'Safari'
  else if (/MSIE|Trident/i.test(s)) browser = 'Internet Explorer'
  else if (/curl\//i.test(s)) browser = 'curl'
  else if (/python/i.test(s)) browser = 'Python script'
  else if (/wget/i.test(s)) browser = 'wget'
  else if (/node-fetch|axios|got\//i.test(s)) browser = 'Node.js script'
  else if (/bot|crawler|spider/i.test(s)) browser = 'Bot/Crawler'

  if (/Windows NT 10/i.test(s)) os = 'Windows 10/11'
  else if (/Windows NT 6\.3/i.test(s)) os = 'Windows 8.1'
  else if (/Windows NT 6\.1/i.test(s)) os = 'Windows 7'
  else if (/Windows/i.test(s)) os = 'Windows'
  else if (/Mac OS X ([0-9_]+)/i.test(s)) {
    const v = (s.match(/Mac OS X ([0-9_]+)/i)||['',''])[1].replace(/_/g,'.')
    os = 'macOS '+v
  }
  else if (/Android ([0-9.]+)/i.test(s)) {
    os = 'Android '+(s.match(/Android ([0-9.]+)/i)||['','?'])[1]
    device = 'mobile'
  }
  else if (/iPhone OS ([0-9_]+)/i.test(s)) {
    os = 'iOS '+(s.match(/iPhone OS ([0-9_]+)/i)||['','?'])[1].replace(/_/g,'.')
    device = 'mobile'
  }
  else if (/iPad/i.test(s)) { os = 'iPadOS'; device = 'tablet' }
  else if (/Linux/i.test(s)) os = 'Linux'
  else if (/CrOS/i.test(s)) os = 'ChromeOS'

  if (/Mobile/i.test(s) && device === 'desktop') device = 'mobile'
  if (/Tablet/i.test(s)) device = 'tablet'
  if (/bot|crawler|spider|headless/i.test(s)) device = 'bot'

  return { browser, os, device, raw: ua }
}

function deviceIcon(d) {
  return { mobile:'📱', tablet:'📟', bot:'🤖', desktop:'🖥' }[d] || '🖥'
}

function openReqDetail(idx, rowEl) {
  const r = activeReqList[idx]
  if (!r) return

  document.querySelectorAll('.req-clickable.selected').forEach(el => el.classList.remove('selected'))
  if (rowEl) rowEl.classList.add('selected')

  const ua = parseUA(r.ua || '')
  const statusColors = { passed: 'var(--green)', blocked: 'var(--red)', flagged: 'var(--yellow)' }
  const statusColor = statusColors[r.status] || 'var(--muted)'

  const detectedBadges = []
  if (r.detected && r.detected !== 'N/A') {
    const badgeColors = {
      tor: 'var(--red)', headless: 'var(--red)', blocked: 'var(--red)',
      datacenter: 'var(--yellow)', crawler: 'var(--muted)', vpn: 'var(--yellow)'
    }
    detectedBadges.push(`<span class="req-detail-badge"><span class="dot" style="background:${badgeColors[r.detected]||'var(--muted)'}"></span>${esc(r.detected)}</span>`)
  }
  if (ua.device !== 'desktop') {
    detectedBadges.push(`<span class="req-detail-badge">${deviceIcon(ua.device)} ${ua.device}</span>`)
  }

  const since = (() => {
    const diff = Date.now() - r.ts
    if (diff < 60000) return Math.floor(diff/1000)+'s ago'
    if (diff < 3600000) return Math.floor(diff/60000)+'m ago'
    if (diff < 86400000) return Math.floor(diff/3600000)+'h ago'
    return Math.floor(diff/86400000)+'d ago'
  })()

  const refId = r.id ? r.id.split('-')[0] : '—'

  document.getElementById('reqDetailBody').innerHTML = `
    <div class="req-detail-status">
      <div class="req-detail-status-inner">
        ${stag(r.status)}
        <div class="req-detail-status-country">${esc(r.country)}</div>
        <div class="req-detail-status-ts">${since} · ${fmtFull(r.ts)}</div>
      </div>
    </div>

    ${detectedBadges.length ? `<div style="margin-bottom:16px">${detectedBadges.join('')}</div>` : ''}

    <div class="req-detail-section">
      <div class="req-detail-section-label">request</div>
      <div class="req-detail-row">
        <span class="req-detail-key">status</span>
        <span class="req-detail-val" style="color:${statusColor};font-weight:600">${r.status}</span>
      </div>
      <div class="req-detail-row">
        <span class="req-detail-key">detected as</span>
        <span class="req-detail-val">${r.detected === 'N/A' ? '—' : esc(r.detected)}</span>
      </div>
      <div class="req-detail-row">
        <span class="req-detail-key">country</span>
        <span class="req-detail-val">${esc(r.country)}</span>
      </div>
      <div class="req-detail-row">
        <span class="req-detail-key">timestamp</span>
        <span class="req-detail-val mono">${fmt(r.ts)}</span>
      </div>
      <div class="req-detail-row">
        <span class="req-detail-key">ref id</span>
        <span class="req-detail-val mono">${refId}…</span>
      </div>
    </div>

    <div class="req-detail-section">
      <div class="req-detail-section-label">client</div>
      <div class="req-detail-row">
        <span class="req-detail-key">browser</span>
        <span class="req-detail-val">${esc(ua.browser)}</span>
      </div>
      <div class="req-detail-row">
        <span class="req-detail-key">os</span>
        <span class="req-detail-val">${esc(ua.os)}</span>
      </div>
      <div class="req-detail-row">
        <span class="req-detail-key">device type</span>
        <span class="req-detail-val">${deviceIcon(ua.device)} ${ua.device}</span>
      </div>
    </div>

    ${ua.raw ? `<div class="req-detail-section">
      <div class="req-detail-section-label">user agent</div>
      <div class="req-detail-ua-block">${esc(ua.raw)}</div>
    </div>` : ''}
  `

  document.getElementById('reqDetailDrawer').classList.add('open')
  document.getElementById('reqDetailOverlay').classList.add('open')
}

function closeReqDetail() {
  document.getElementById('reqDetailDrawer').classList.remove('open')
  document.getElementById('reqDetailOverlay').classList.remove('open')
  document.querySelectorAll('.req-clickable.selected').forEach(el => el.classList.remove('selected'))
}

function renderInstall(site) {
  const key = esc(site.key)
  const ttl = site.settings.challengeTtl || 24
  document.getElementById('installWrap').innerHTML = `
    <div style="margin-bottom:18px">
      <div style="font-family:var(--display);font-size:15px;font-weight:700;margin-bottom:5px">installation</div>
      <p style="color:var(--muted);font-size:12px;line-height:1.75">follow these steps to protect <strong style="color:var(--text2)">${esc(site.domain)}</strong>. no server-side code needed.</p>
    </div>
    <div style="background:rgba(217,95,43,.08);border:1px solid rgba(217,95,43,.25);border-radius:4px;padding:12px 14px;margin-bottom:18px;font-size:11px;line-height:1.75;color:var(--text2)">
      <strong style="color:var(--accent)">⚠ if you're seeing "unknown site key"</strong> — your embed script still has an old key from before the database migration. rotate and copy the fresh key below and update the <code style="color:var(--accent2)">data-site</code> attribute in your html.
    </div>
    <div class="install-steps">
      <div class="install-step">
        <div class="install-step-num">1</div>
        <div style="flex:1;min-width:0">
          <div class="install-step-title">copy your site key</div>
          <div class="install-step-desc">this key signs visitor tokens. keep it private — rotating it invalidates all existing tokens immediately.</div>
          <div class="key-row">
            <span class="key-val">${key}</span>
            <div class="key-actions">
              <button class="btn btn-ghost btn-sm" onclick="copyKey()">copy</button>
              <button class="btn btn-ghost btn-sm" onclick="rotateKey()">rotate</button>
            </div>
          </div>
        </div>
      </div>
      <div class="install-step">
        <div class="install-step-num">2</div>
        <div style="flex:1;min-width:0">
          <div class="install-step-title">add the script tag to your site</div>
          <div class="install-step-desc">paste this into the <code style="color:var(--accent2)">&lt;head&gt;</code> of every page you want protected. works on any html — static sites, jamstack, single-page apps.</div>
          <div class="code-block" id="cb-snippet"><button class="code-copy" onclick="cpSnippet(this,'${site.key}')">copy</button>&lt;script src="https://brickwall.onrender.com/js/protect.min.js"
  data-site="${key}"&gt;&lt;/script&gt;</div>
        </div>
      </div>
      <div class="install-step">
        <div class="install-step-num">3</div>
        <div style="flex:1;min-width:0">
          <div class="install-step-title">test it</div>
          <div class="install-step-desc">open your site in a private/incognito window. you should be redirected to the brickwall challenge page, then sent back after passing. the token lasts ${ttl} hour${ttl!==1?'s':''} — configurable in <a href="#" onclick="nav('settings');return false" style="color:var(--accent2)">settings</a>.</div>
          <div class="install-step-desc">once you see requests showing up in the <a href="#" onclick="nav('requests');return false" style="color:var(--accent2)">requests log</a>, you're good.</div>
        </div>
      </div>
    </div>
    <div class="install-block">
      <div class="install-block-head">server-side verification (optional)</div>
      <div class="install-block-body">
        <div class="install-step-desc" style="margin-bottom:10px">if your backend needs to verify tokens independently — e.g. to gate an api route — POST to this endpoint:</div>
        <div class="code-block"><button class="code-copy" onclick="cpRaw(this,\`POST /api/challenge/check\\nContent-Type: application/json\\n\\n{\\n  &quot;token&quot;: &quot;&lt;bw_token&gt;&quot;,\\n  &quot;siteKey&quot;: &quot;${site.key}&quot;\\n}\`)">copy</button>POST /api/challenge/check
Content-Type: application/json

{
  "token": "&lt;bw_token from visitor&gt;",
  "siteKey": "${key}"
}</div>
        <p class="install-note">returns <code style="color:var(--accent2)">{"valid":true}</code> or <code style="color:var(--accent2)">{"valid":false}</code>. the visitor token is stored in their localStorage as <code style="color:var(--accent2)">bw_token_${key}</code>.</p>
      </div>
    </div>
    <div class="install-block">
      <div class="install-block-head">self-hosting the script</div>
      <div class="install-block-body">
        <div class="code-block"><button class="code-copy" onclick="cpRaw(this,'curl -o protect.min.js https://brickwall.onrender.com/js/protect.min.js')">copy</button>curl -o protect.min.js https://brickwall.onrender.com/js/protect.min.js</div>
        <p class="install-note">download and serve from your own cdn if preferred. the <code style="color:var(--accent2)">data-site</code> attribute still needs your key, and <code style="color:var(--accent2)">data-api</code> + <code style="color:var(--accent2)">data-challenge</code> attributes can override the default endpoints.</p>
      </div>
    </div>
  `
}

function cpSnippet(btn, key) {
  navigator.clipboard.writeText(`<script src="https://brickwall.onrender.com/js/protect.min.js" data-site="${key}"><\/script>`)
  btn.textContent='copied!'; setTimeout(()=>btn.textContent='copy',2000)
}

function cpRaw(btn, text) {
  const clean = text.replace(/\\n/g,'\n').replace(/\\"/g,'"').replace(/&quot;/g,'"').replace(/&lt;/g,'<').replace(/&gt;/g,'>')
  navigator.clipboard.writeText(clean)
  btn.textContent='copied!'; setTimeout(()=>btn.textContent='copy',2000)
}

function renderSettings(site) {
  document.getElementById('settingsWrap').innerHTML = `
    <div class="settings-group">
      <div class="settings-group-head">site info</div>
      <div class="settings-group-body">
        <div class="settings-row">
          <div><div class="settings-label">site name</div><div class="settings-desc">display name in your dashboard</div></div>
          <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
            <input type="text" id="settingName" value="${esc(site.name)}" placeholder="my site" style="width:140px;font-size:11px">
            <button class="btn btn-ghost btn-sm" onclick="saveName()">save</button>
          </div>
        </div>
        <div class="settings-row" style="padding-bottom:0;border-bottom:none">
          <div><div class="settings-label">domain</div><div class="settings-desc">changing this rotates the key and takes you to installation</div></div>
          <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
            <input type="text" id="settingDomain" value="${esc(site.domain)}" placeholder="example.com" style="width:160px;font-size:11px;font-family:var(--mono)">
            <button class="btn btn-ghost btn-sm" onclick="saveDomain()">save</button>
          </div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head">access control</div>
      <div class="settings-group-body">
        <div class="settings-row">
          <div><div class="settings-label">allow search engine crawlers</div><div class="settings-desc">googlebot, bingbot, etc. auto-bypass and are logged as "crawler"</div></div>
          <label class="toggle"><input type="checkbox" id="setCrawlers" ${site.settings.allowCrawlers?'checked':''} onchange="saveSetting('allowCrawlers',this.checked)"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">block tor exit nodes</div><div class="settings-desc">known tor exit ip ranges are denied before the challenge</div></div>
          <label class="toggle"><input type="checkbox" id="setTor" ${site.settings.blockTor?'checked':''} onchange="saveSetting('blockTor',this.checked)"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">block vpn / datacenter ips</div><div class="settings-desc">known hosting asns and vpn exit ranges flagged or blocked</div></div>
          <label class="toggle"><input type="checkbox" id="setVpn" ${site.settings.blockVpn?'checked':''} onchange="saveSetting('blockVpn',this.checked)"><span class="toggle-slider"></span></label>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <span>bot allowlist</span>
        <span style="font-size:10px;color:var(--muted);font-family:var(--mono);font-weight:400">auto-pass, logged as "allowed"</span>
      </div>
      <div class="settings-group-body">
        <div class="botlist-tabs">
          <button class="botlist-tab active-tab" id="botTabName" onclick="switchBotTab('name')">robots.txt name</button>
          <button class="botlist-tab" id="botTabUa" onclick="switchBotTab('ua')">ua string match</button>
        </div>
        <div class="botlist-tab-panel active-tab-panel" id="botPanelName">
          <div class="botlist-hint">enter the bot name as it appears in robots.txt — e.g. <code style="color:var(--accent2)">Twitterbot</code>. matched case-insensitively against the user agent.</div>
          <div class="botlist-input-row">
            <input class="botlist-input" type="text" id="botNameInput" placeholder="e.g. Twitterbot" autocomplete="off" onkeydown="if(event.key==='Enter')addAllowedBot('name')">
            <button class="btn btn-ghost btn-sm" onclick="addAllowedBot('name')">add</button>
          </div>
          <div style="margin-top:8px">
            <div class="known-bots-grid" id="knownBotBtns"></div>
          </div>
          <div style="margin-top:10px">
            <div class="botlist-chips" id="allowedNameChips"></div>
          </div>
        </div>
        <div class="botlist-tab-panel" id="botPanelUa">
          <div class="botlist-hint">enter any substring to match against the raw user agent string. useful for internal tools or custom bots.</div>
          <div class="botlist-input-row">
            <input class="botlist-input" type="text" id="botUaInput" placeholder="e.g. MyCustomBot/1.0" autocomplete="off" onkeydown="if(event.key==='Enter')addAllowedBot('ua')">
            <button class="btn btn-ghost btn-sm" onclick="addAllowedBot('ua')">add</button>
          </div>
          <div style="margin-top:10px">
            <div class="botlist-chips" id="allowedUaChips"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head">token lifetime</div>
      <div class="settings-group-body">
        <div class="settings-row">
          <div><div class="settings-label">challenge ttl</div><div class="settings-desc">how long a verified token lasts before re-challenge</div></div>
          <div class="settings-ttl">
            <input type="number" class="ttl-input" id="setTtl" min="1" max="720" value="${site.settings.challengeTtl||24}">
            <span style="color:var(--muted);font-size:11px">hours</span>
            <button class="btn btn-ghost btn-sm" onclick="saveTtl()">save</button>
          </div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head">site status</div>
      <div class="settings-group-body">
        <div class="settings-row" style="border-bottom:none;padding-bottom:0">
          <div><div class="settings-label">active</div><div class="settings-desc">when off, all visitors pass through without any challenge</div></div>
          <label class="toggle"><input type="checkbox" id="setActive" ${site.active?'checked':''} onchange="saveActive(this.checked)"><span class="toggle-slider"></span></label>
        </div>
      </div>
    </div>
    <div class="danger-zone">
      <h4>danger zone</h4>
      <div style="margin-bottom:14px">
        <div class="settings-label" style="margin-bottom:4px">delete this site</div>
        <div class="settings-desc" style="margin-bottom:10px">permanently removes the site, its api key, and all request history.</div>
        <button class="btn btn-danger btn-sm" onclick="openDeleteSite()">delete site</button>
      </div>
      <div>
        <div class="settings-label" style="margin-bottom:4px">delete your account</div>
        <div class="settings-desc" style="margin-bottom:10px">deletes your account and all sites permanently. cannot be undone.</div>
        <button class="btn btn-danger btn-sm" onclick="openDeleteAccount()">delete account</button>
      </div>
    </div>
  ` + renderChallengeSettings(site)
}

const CHALLENGE_COLOR_VARS = [
  { key: 'bg', label: 'background', desc: 'page background color' },
  { key: 'accent', label: 'accent', desc: 'spinner, progress bar, highlights' },
  { key: 'surface', label: 'surface', desc: 'log panel background' },
  { key: 'text', label: 'text', desc: 'headline text color' },
  { key: 'text2', label: 'text secondary', desc: 'secondary labels' },
  { key: 'muted', label: 'muted', desc: 'subline and log text' },
  { key: 'border', label: 'border', desc: 'panel borders' },
  { key: 'border2', label: 'border 2', desc: 'ring and input borders' },
]

function getChallengeUi(site) {
  return site.settings.challengeUi || {}
}

function renderChallengeSettings(site) {
  const ui = getChallengeUi(site)
  const colors = ui.colors || {}
  const colorRows = CHALLENGE_COLOR_VARS.map(cv => {
    const val = colors[cv.key] || ''
    const swatchColor = val || '#888888'
    return `<div class="challenge-color-row">
      <div>
        <div class="customize-label">${cv.label}</div>
        <div class="customize-desc">${cv.desc}</div>
      </div>
      <div class="color-input-wrap">
        <div class="color-swatch" title="click to pick">
          <div class="color-swatch-preview" id="chal-swatch-${cv.key}" style="background:${val||'var(--border2)'}${val?'':';opacity:.4'}"></div>
          <input type="color" value="${val||'#000000'}" id="chal-color-${cv.key}"
            oninput="onChalColorInput('${cv.key}',this.value)"
            onchange="onChalColorInput('${cv.key}',this.value)">
        </div>
        <input class="color-hex" type="text" value="${val}" maxlength="7" id="chal-hex-${cv.key}"
          placeholder="inherit"
          oninput="onChalHexInput('${cv.key}',this)"
          onblur="onChalHexBlur('${cv.key}',this)">
      </div>
    </div>`
  }).join('')

  return `
    <div class="settings-group" style="margin-top:20px">
      <div class="settings-group-head" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <span>challenge page</span>
        <button class="customize-reset-btn" onclick="resetChallengeUi()">reset</button>
      </div>
      <div class="settings-group-body">
        <div class="settings-row">
          <div><div class="settings-label">headline text</div><div class="settings-desc">overrides "verifying your browser"</div></div>
          <input class="challenge-text-input" type="text" id="chal-headline" value="${esc(ui.headline||'')}" placeholder="verifying your browser" maxlength="120">
        </div>
        <div class="settings-row">
          <div><div class="settings-label">subline text</div><div class="settings-desc">overrides the small description below the headline</div></div>
          <input class="challenge-text-input" type="text" id="chal-subline" value="${esc(ui.subline||'')}" placeholder="this only takes a moment..." maxlength="300">
        </div>
        <div class="settings-row">
          <div><div class="settings-label">logo text</div><div class="settings-desc">replaces "brickwall" in the top logo — plain text only</div></div>
          <input class="challenge-text-input" type="text" id="chal-logoText" value="${esc(ui.logoText||'')}" placeholder="brickwall" maxlength="60">
        </div>
        <div class="settings-row">
          <div><div class="settings-label">hide progress log</div><div class="settings-desc">hides the &gt; checking environment / running pow... panel</div></div>
          <label class="toggle"><input type="checkbox" id="chal-hideStepsLog" ${ui.hideStepsLog?'checked':''} onchange="saveChallengeToggle('hideStepsLog',this.checked)"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row" style="border-bottom:none;padding-bottom:0">
          <div><div class="settings-label">hide "protected by brickwall" badge</div><div class="settings-desc">removes the footer attribution link</div></div>
          <label class="toggle"><input type="checkbox" id="chal-hideBadge" ${ui.hideBadge?'checked':''} onchange="saveChallengeToggle('hideBadge',this.checked)"><span class="toggle-slider"></span></label>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head">challenge page colors</div>
      <div class="settings-group-body" style="padding:0 16px">
        ${colorRows}
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-head">custom css</div>
      <div class="settings-group-body">
        <div style="color:var(--muted);font-size:11px;margin-bottom:10px;line-height:1.6">injected into the challenge page after all other styles. full css supported — target <code style="color:var(--accent2)">.box</code>, <code style="color:var(--accent2)">.headline</code>, <code style="color:var(--accent2)">.status-ring</code>, <code style="color:var(--accent2)">.steps-log</code>, <code style="color:var(--accent2)">.brickwall-badge</code>, etc.</div>
        <textarea class="css-textarea" id="chal-css" placeholder="/* e.g. .brickwall-badge { display: none; } */">${esc(ui.css||'')}</textarea>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:20px">
      <button class="btn btn-primary btn-sm challenge-save-btn" onclick="saveChallengeUi()">save challenge settings</button>
      <button class="btn btn-ghost btn-sm" onclick="previewChallengeUi()">preview →</button>
    </div>
  `
}

function onChalColorInput(key, val) {
  const swatch = document.getElementById('chal-swatch-'+key)
  if (swatch) { swatch.style.background = val; swatch.style.opacity = '1' }
  const hex = document.getElementById('chal-hex-'+key)
  if (hex && document.activeElement !== hex) hex.value = val
}

function onChalHexInput(key, input) {
  const v = input.value.trim()
  if (/^#[0-9a-fA-F]{6}$/.test(v)) {
    const ci = document.getElementById('chal-color-'+key)
    if (ci) ci.value = v
    const sw = document.getElementById('chal-swatch-'+key)
    if (sw) { sw.style.background = v; sw.style.opacity = '1' }
  }
}

function onChalHexBlur(key, input) {
  const v = input.value.trim()
  if (v && !/^#[0-9a-fA-F]{6}$/.test(v)) input.value = ''
}

async function saveChallengeToggle(field, val) {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  if (!site.settings.challengeUi) site.settings.challengeUi = {}
  site.settings.challengeUi[field] = val
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
  sites = sites.map(s => s.id===currentSiteId?site:s)
}

async function saveChallengeUi() {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  const colors = {}
  CHALLENGE_COLOR_VARS.forEach(cv => {
    const hex = document.getElementById('chal-hex-'+cv.key)?.value.trim()
    if (hex && /^#[0-9a-fA-F]{6}$/.test(hex)) colors[cv.key] = hex
  })
  const headline = document.getElementById('chal-headline')?.value.trim() || ''
  const subline = document.getElementById('chal-subline')?.value.trim() || ''
  const logoText = document.getElementById('chal-logoText')?.value.trim() || ''
  const css = document.getElementById('chal-css')?.value || ''
  const hideStepsLog = document.getElementById('chal-hideStepsLog')?.checked || false
  const hideBadge = document.getElementById('chal-hideBadge')?.checked || false
  const challengeUi = {}
  if (Object.keys(colors).length) challengeUi.colors = colors
  if (headline) challengeUi.headline = headline
  if (subline) challengeUi.subline = subline
  if (logoText) challengeUi.logoText = logoText
  if (css.trim()) challengeUi.css = css
  if (hideStepsLog) challengeUi.hideStepsLog = true
  if (hideBadge) challengeUi.hideBadge = true
  site.settings.challengeUi = challengeUi
  const r = await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
  if (r.ok) {
    sites = sites.map(s => s.id===currentSiteId?site:s)
    const btn = document.querySelector('.challenge-save-btn')
    if (btn) { btn.textContent = 'saved ✓'; setTimeout(()=>btn.textContent='save challenge settings',2000) }
  }
}

async function resetChallengeUi() {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  site.settings.challengeUi = {}
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
  sites = sites.map(s => s.id===currentSiteId?site:s)
  renderSettings(site)
}

function previewChallengeUi() {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  window.open('/challenge.html?k='+encodeURIComponent(site.key)+'&r='+encodeURIComponent(location.href), '_blank')
}

const KNOWN_BOT_NAMES = [
  'Twitterbot','Discordbot','Slackbot','LinkedInBot','WhatsApp',
  'Telegrambot','Pinterestbot','redditbot','Applebot','Facebot',
  'ia_archiver','AhrefsBot','SemrushBot','MJ12bot','DotBot',
  'UptimeRobot','Dataprovider','Screaming Frog','SiteAuditBot','GPTBot',
  'ClaudeBot','PerplexityBot','YouBot','ChatGPT-User','Bytespider'
]

let botTabActive = 'name'

function switchBotTab(tab) {
  botTabActive = tab
  document.getElementById('botTabName').classList.toggle('active-tab', tab === 'name')
  document.getElementById('botTabUa').classList.toggle('active-tab', tab === 'ua')
  document.getElementById('botPanelName').classList.toggle('active-tab-panel', tab === 'name')
  document.getElementById('botPanelUa').classList.toggle('active-tab-panel', tab === 'ua')
}

function renderBotAllowlist(site) {
  const allowed = site.settings.allowedBots || { names: [], uaStrings: [] }
  const names = allowed.names || []
  const uaStrings = allowed.uaStrings || []

  const nameChips = document.getElementById('allowedNameChips')
  const uaChips = document.getElementById('allowedUaChips')
  const knownGrid = document.getElementById('knownBotBtns')
  if (!nameChips || !uaChips || !knownGrid) return

  knownGrid.innerHTML = KNOWN_BOT_NAMES
    .filter(b => !names.some(n => n.toLowerCase() === b.toLowerCase()))
    .map(b => `<button class="known-bot-btn" onclick="addKnownBot('${esc(b)}')">${esc(b)}</button>`)
    .join('')

  nameChips.innerHTML = names.length
    ? names.map((n,i) => `<span class="botlist-chip">${esc(n)}<button class="botlist-chip-remove" onclick="removeAllowedBot('name',${i})" title="remove">×</button></span>`).join('')
    : '<span class="botlist-empty">no names added yet</span>'

  uaChips.innerHTML = uaStrings.length
    ? uaStrings.map((u,i) => `<span class="botlist-chip">${esc(u)}<button class="botlist-chip-remove" onclick="removeAllowedBot('ua',${i})" title="remove">×</button></span>`).join('')
    : '<span class="botlist-empty">no ua strings added yet</span>'
}

async function addAllowedBot(type) {
  const inputId = type === 'name' ? 'botNameInput' : 'botUaInput'
  const input = document.getElementById(inputId)
  if (!input) return
  const val = input.value.trim()
  if (!val) return
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  if (!site.settings.allowedBots) site.settings.allowedBots = { names: [], uaStrings: [] }
  const list = type === 'name' ? site.settings.allowedBots.names : site.settings.allowedBots.uaStrings
  if (list.some(x => x.toLowerCase() === val.toLowerCase())) { input.value = ''; return }
  list.push(val)
  input.value = ''
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
  sites = sites.map(s => s.id===currentSiteId?site:s)
  renderBotAllowlist(site)
}

async function addKnownBot(name) {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  if (!site.settings.allowedBots) site.settings.allowedBots = { names: [], uaStrings: [] }
  if (site.settings.allowedBots.names.some(x => x.toLowerCase() === name.toLowerCase())) return
  site.settings.allowedBots.names.push(name)
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
  sites = sites.map(s => s.id===currentSiteId?site:s)
  renderBotAllowlist(site)
}

async function removeAllowedBot(type, idx) {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site || !site.settings.allowedBots) return
  const list = type === 'name' ? site.settings.allowedBots.names : site.settings.allowedBots.uaStrings
  list.splice(idx, 1)
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
  sites = sites.map(s => s.id===currentSiteId?site:s)
  renderBotAllowlist(site)
}

function renderSitesGrid() {
  const grid = document.getElementById('sitesGrid')
  grid.innerHTML = sites.map(s => `
    <div class="site-card ${s.id===currentSiteId?'selected':''}" onclick="selectSite('${esc(s.id)}')">
      <div class="site-card-top">
        <div>
          <div class="site-card-name">${esc(s.name)}</div>
          <div class="site-card-domain">${esc(s.domain)}</div>
        </div>
        <span class="tag ${s.active?'tag-green':'tag-muted'}">${s.active?'active':'paused'}</span>
      </div>
      <div class="site-card-key">${esc(s.key)}</div>
    </div>
  `).join('') + `<div class="add-site-btn" onclick="openAddSite()"><span>+</span> add site</div>`
}

async function selectSite(id) {
  currentSiteId = id
  document.getElementById('siteSelect').value = id
  closeSidebar()
  await refreshData()
}

async function saveSetting(key, val) {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  site.settings[key] = val
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
  sites = sites.map(s => s.id===currentSiteId?site:s)
}

async function saveName() {
  const name = document.getElementById('settingName').value.trim()
  if (!name) return
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})})
  await loadSites()
}

async function saveDomain() {
  const input = document.getElementById('settingDomain')
  if (!input) return
  const raw = input.value.trim()
  if (!raw) return
  const domain = raw.replace(/^https?:\/\//,'').split('/')[0]
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  if (domain === site.domain) return
  const btn = input.nextElementSibling
  if (btn) { btn.disabled = true; btn.textContent = 'saving...' }
  const r = await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain})})
  if (!r.ok) {
    if (btn) { btn.disabled = false; btn.textContent = 'save' }
    return
  }
  const updated = await r.json()
  sites = sites.map(s => s.id === currentSiteId ? { ...s, domain: updated.domain, key: updated.key } : s)
  const sel = document.getElementById('siteSelect')
  if (sel) {
    Array.from(sel.options).forEach(o => {
      if (o.value === currentSiteId) o.textContent = updated.name + ' (' + updated.domain + ')'
    })
  }
  document.getElementById('pageSub').textContent = updated.domain
  await refreshData()
  nav('install')
}

async function saveTtl() {
  const ttl = parseInt(document.getElementById('setTtl').value)
  if (!ttl || ttl < 1) return
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  site.settings.challengeTtl = ttl
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:site.settings})})
}

async function saveActive(val) {
  await fetch('/api/sites/'+currentSiteId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({active:val})})
  const site = sites.find(s => s.id === currentSiteId)
  if (site) site.active = val
}

function copyKey() {
  const site = sites.find(s => s.id === currentSiteId)
  if (site) navigator.clipboard.writeText(site.key)
}

async function rotateKey() {
  if (!confirm('rotate api key? all existing visitor tokens will be invalidated immediately.')) return
  const r = await fetch('/api/sites/'+currentSiteId+'/rotate',{method:'POST'})
  if (!r.ok) return
  const d = await r.json()
  const site = sites.find(s => s.id === currentSiteId)
  if (site) { site.key = d.key; renderInstall(site) }
}

function saveDomain() {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  const raw = document.getElementById('settingDomain')?.value.trim() || ''
  const newDomain = raw.replace(/^https?:\/\//,'').split('/')[0]
  if (!newDomain || newDomain === site.domain) return
  const modal = document.getElementById('terminalModal')
  const cmd = `sudo apt install brickwall-sites new-domain ${newDomain}`
  document.getElementById('terminalPrompt').textContent = '$ ' + cmd
  document.getElementById('terminalInput').value = ''
  document.getElementById('terminalError').style.display = 'none'
  modal.dataset.mode = 'domain'
  modal.dataset.expected = cmd
  modal.dataset.newDomain = newDomain
  modal.classList.add('open')
  setTimeout(() => document.getElementById('terminalInput').focus(), 100)
}

function openDeleteSite() {
  const site = sites.find(s => s.id === currentSiteId)
  if (!site) return
  const modal = document.getElementById('terminalModal')
  const cmd = `sudo delete brickwall-sites ${site.domain}`
  document.getElementById('terminalPrompt').textContent = '$ ' + cmd
  document.getElementById('terminalInput').value = ''
  document.getElementById('terminalError').style.display = 'none'
  modal.dataset.mode = 'site'
  modal.dataset.expected = cmd
  modal.classList.add('open')
  setTimeout(() => document.getElementById('terminalInput').focus(), 100)
}

function openDeleteAccount() {
  const modal = document.getElementById('terminalModal')
  const cmd = `sudo delete brickwall-accounts ${currentUser.email}`
  document.getElementById('terminalPrompt').textContent = '$ ' + cmd
  document.getElementById('terminalInput').value = ''
  document.getElementById('terminalError').style.display = 'none'
  modal.dataset.mode = 'account'
  modal.dataset.expected = cmd
  modal.classList.add('open')
  setTimeout(() => document.getElementById('terminalInput').focus(), 100)
}

function closeTerminalModal() {
  document.getElementById('terminalModal').classList.remove('open')
}

async function confirmTerminalDelete() {
  const modal = document.getElementById('terminalModal')
  const input = document.getElementById('terminalInput').value.trim()
  const expected = modal.dataset.expected
  const err = document.getElementById('terminalError')
  if (input !== expected) {
    err.textContent = 'command does not match. copy it exactly.'
    err.style.display = 'block'
    document.getElementById('terminalInput').style.animation = 'shake .3s ease'
    setTimeout(() => document.getElementById('terminalInput').style.animation = '', 300)
    return
  }
  const btn = document.getElementById('terminalConfirmBtn')
  btn.disabled = true; btn.textContent = 'applying...'
  if (modal.dataset.mode === 'domain') {
    const newDomain = modal.dataset.newDomain
    const r = await fetch('/api/sites/'+currentSiteId+'/domain',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain:newDomain})})
    if (!r.ok) {
      const d = await r.json()
      err.textContent = d.error || 'failed to update domain'
      err.style.display = 'block'
      btn.disabled = false; btn.textContent = 'confirm delete'
      return
    }
    const d = await r.json()
    const site = sites.find(s => s.id === currentSiteId)
    if (site) { site.domain = d.domain; site.key = d.key }
    sites = sites.map(s => s.id===currentSiteId ? (site||s) : s)
    modal.classList.remove('open')
    await loadSites()
    nav('install')
  } else if (modal.dataset.mode === 'site') {
    await fetch('/api/sites/'+currentSiteId,{method:'DELETE'})
    modal.classList.remove('open')
    currentSiteId = null
    await loadSites()
    nav('sites')
  } else {
    await fetch('/api/auth/account',{method:'DELETE'})
    window.location.href = '/'
  }
  btn.disabled = false; btn.textContent = 'confirm delete'
}

function openAddSite() { document.getElementById('addSiteModal').classList.add('open') }
function closeAddSiteModal(e) { if (e.target===document.getElementById('addSiteModal')) document.getElementById('addSiteModal').classList.remove('open') }

async function doAddSite() {
  const name = document.getElementById('newSiteName').value.trim()
  const domain = document.getElementById('newSiteDomain').value.trim()
  const err = document.getElementById('addSiteError')
  err.style.display = 'none'
  if (!name||!domain) { err.textContent='fill in both fields'; err.style.display='block'; return }
  const btn = document.getElementById('addSiteBtn')
  btn.disabled=true; btn.textContent='adding...'
  const r = await fetch('/api/sites',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,domain})})
  if (!r.ok) {
    const d = await r.json()
    err.textContent = d.error||'failed to add site'
    err.style.display = 'block'
    btn.disabled=false; btn.textContent='add site →'
    return
  }
  const site = await r.json()
  document.getElementById('addSiteModal').classList.remove('open')
  document.getElementById('newSiteName').value=''
  document.getElementById('newSiteDomain').value=''
  btn.disabled=false; btn.textContent='add site →'
  currentSiteId = site.id
  await loadSites()
  nav('install')
}

const panelTitles = {
  overview:['overview',''],
  requests:['all requests','every verification attempt'],
  install:['installation','embed brickwall on your site'],
  settings:['site settings','configure protection options'],
  sites:['manage sites','add, switch, or remove sites'],
  account:['account','your profile and danger zone'],
}

function nav(page) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'))
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'))
  document.getElementById('panel-'+page).classList.add('active')
  document.getElementById('nav-'+page)?.classList.add('active')
  const [title,sub] = panelTitles[page]||[page,'']
  document.getElementById('pageTitle').textContent = title
  const site = sites.find(s=>s.id===currentSiteId)
  document.getElementById('pageSub').textContent = sub||(site?site.domain:'')
  if (page==='requests') renderAllTable()
  if (page==='sites') renderSitesGrid()
  closeReqDetail()
  if (page==='account') {
    document.getElementById('acctName').textContent = currentUser?.name || '—'
    document.getElementById('acctEmail').textContent = currentUser?.email || '—'
    renderCustomizePanel()
  }
  closeSidebar()
}

async function doLogout() {
  await fetch('/api/auth/logout',{method:'POST'})
  window.location.href = '/'
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')
}

init()
</script>
</body>
</html>
